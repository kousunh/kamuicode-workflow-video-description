name: Gemini-Video Text Enhancer

on:
  workflow_dispatch:
    inputs:
      video_path:
        description: 'åˆ†æå¯¾è±¡ã®å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ï¼ˆãƒªãƒã‚¸ãƒˆãƒªå†…ã®ç›¸å¯¾ãƒ‘ã‚¹ï¼‰ã€‚auto-selectã¯videosãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®æœ€æ–°ã®å‹•ç”»ã‚’é¸æŠ'
        required: true
        type: string
        default: 'auto-select'
      edit_title:
        description: 'å‹•ç”»ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆçœç•¥æ™‚ã¯è‡ªå‹•ç”Ÿæˆï¼‰'
        required: false
        type: string
      description_prompt:
        description: 'èª¬æ˜æ–‡ç”Ÿæˆæ™‚ã®è¿½åŠ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆä»»æ„ï¼‰'
        required: false
        type: string
      text_position:
        description: 'ãƒ†ã‚­ã‚¹ãƒˆã®è¡¨ç¤ºä½ç½®'
        required: false
        type: choice
        default: 'auto'
        options:
          - 'auto'
          - 'å·¦ä¸Š'
          - 'ä¸Š'
          - 'å³ä¸Š'
          - 'å·¦ä¸‹'
          - 'ä¸‹'
          - 'å³ä¸‹'
      generate_title_image:
        description: 'èƒŒæ™¯ç”»åƒã‚’ç”Ÿæˆã—ã¦ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢ã‚’è¿½åŠ ã™ã‚‹'
        required: false
        type: boolean
        default: true
      generate_background_music:
        description: 'èƒŒæ™¯éŸ³æ¥½ã‚’è¿½åŠ ã™ã‚‹'
        required: false
        type: boolean
        default: true

permissions:
  contents: write
  pull-requests: write

env:
  GIT_USER_NAME: "github-actions[bot]"
  GIT_USER_EMAIL: "github-actions[bot]@users.noreply.github.com"
  FONT_FILE: "/usr/share/fonts/opentype/noto/NotoSansCJK-Regular.ttc"

jobs:
  setup-branch:
    runs-on: ubuntu-latest
    outputs:
      branch-name: ${{ steps.branch.outputs.branch-name }}
      folder-name: ${{ steps.branch.outputs.folder-name }}
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.PAT_TOKEN || github.token }}
        
    - name: Create branch name
      id: branch
      run: |
        TIMESTAMP=$(TZ=Asia/Tokyo date +%Y%m%d-%H%M%S)
        BRANCH_NAME="video-edit-$TIMESTAMP"
        FOLDER_NAME="movie-edit-$TIMESTAMP"
        echo "branch-name=$BRANCH_NAME" >> $GITHUB_OUTPUT
        echo "folder-name=$FOLDER_NAME" >> $GITHUB_OUTPUT
        
    - name: Create and switch to new branch
      run: |
        git config --global user.name "${{ env.GIT_USER_NAME }}"
        git config --global user.email "${{ env.GIT_USER_EMAIL }}"
        git checkout -b "${{ steps.branch.outputs.branch-name }}"
        git push -u origin "${{ steps.branch.outputs.branch-name }}"

  analyze-video:
    runs-on: ubuntu-latest
    needs: setup-branch
    outputs:
      title: ${{ steps.verify.outputs.title }}
      analysis-completed: ${{ steps.verify.outputs.completed }}
      descriptions-summary: ${{ steps.verify.outputs.descriptions-summary }}
      actual-video-path: ${{ steps.detect-video.outputs.video-path }}
      title-prompt: ${{ steps.load-prompts.outputs.title-prompt }}
      overlay-prompt: ${{ steps.load-prompts.outputs.overlay-prompt }}
      title-settings: ${{ steps.load-ffmpeg-settings.outputs.TITLE_SETTINGS_JSON }}
      overlay-settings: ${{ steps.load-ffmpeg-settings.outputs.OVERLAY_SETTINGS_JSON }}
      
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        ref: ${{ needs.setup-branch.outputs.branch-name }}
        
    - name: Detect video file
      id: detect-video
      run: |
        VIDEO_PATH="${{ github.event.inputs.video_path }}"
        
        # If auto-select is specified, find the most recently updated video
        if [ "$VIDEO_PATH" = "auto-select" ]; then
          echo "ğŸ” è‡ªå‹•é¸æŠãƒ¢ãƒ¼ãƒ‰: videosãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‹ã‚‰æœ€æ–°ã®å‹•ç”»ã‚’æ¤œç´¢ä¸­..."
          
          # Find the most recently modified video file in the videos directory
          echo "ğŸ“‚ videosãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å†…å®¹:"
          ls -la videos/ || true
          
          # Use git log to find the most recently committed video file
          echo "ğŸ” Gitã®å±¥æ­´ã‹ã‚‰æœ€æ–°ã®å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œç´¢ä¸­..."
          
          # Show recent commits for videos
          echo "ğŸ“‹ æœ€è¿‘ã®ãƒ“ãƒ‡ã‚ªãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚³ãƒŸãƒƒãƒˆå±¥æ­´:"
          git log --oneline --name-only --pretty=format:"%h %ad %s" --date=short -- 'videos/*' | head -20 || true
          
          # Get the most recently modified video file from filesystem
          # Using ls -t to sort by modification time (newest first)
          echo "ğŸ“¹ ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã‹ã‚‰æœ€æ–°ã®å‹•ç”»ã‚’æ¤œç´¢ã—ã¾ã™..."
          LATEST_VIDEO=$(ls -t videos/*.mp4 videos/*.avi videos/*.mov videos/*.mkv videos/*.webm 2>/dev/null | head -1)
          
          # Alternative: Get the most recently committed video from git history
          # This would require more complex parsing to get the actual latest file
          # LATEST_VIDEO=$(git log --name-only --pretty=format: -- 'videos/*.mp4' 'videos/*.avi' 'videos/*.mov' 'videos/*.mkv' 'videos/*.webm' | grep -E '\.(mp4|avi|mov|mkv|webm)$' | head -1)
          
          if [ -z "$LATEST_VIDEO" ]; then
            echo "âŒ videosãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            exit 1
          fi
          
          VIDEO_PATH="$LATEST_VIDEO"
          echo "âœ… æœ€æ–°ã®å‹•ç”»ã‚’æ¤œå‡ºã—ã¾ã—ãŸ: $VIDEO_PATH"
          echo "ğŸ“¹ é¸æŠã•ã‚ŒãŸå‹•ç”»: $VIDEO_PATH"
          
          # å‹•ç”»ã®æ›´æ–°æ—¥æ™‚ã‚‚è¡¨ç¤ºï¼ˆè¤‡æ•°ã®æ–¹æ³•ã‚’è©¦ã™ï¼‰
          if command -v stat >/dev/null 2>&1; then
            # GNU stat (Linux)
            VIDEO_DATE=$(stat -c "%y" "$VIDEO_PATH" 2>/dev/null)
            if [ -z "$VIDEO_DATE" ]; then
              # BSD stat (macOS)
              VIDEO_DATE=$(stat -f "%Sm" -t "%Y-%m-%d %H:%M:%S" "$VIDEO_PATH" 2>/dev/null)
            fi
          fi
          
          if [ -n "$VIDEO_DATE" ]; then
            echo "ğŸ“… æ›´æ–°æ—¥æ™‚: $VIDEO_DATE"
          fi
          
          # ãƒ‡ãƒãƒƒã‚°æƒ…å ±ï¼šå…¨å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ã®æ›´æ–°æ—¥æ™‚ã‚’è¡¨ç¤º
          echo "ğŸ” å…¨å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ã®æ›´æ–°æ—¥æ™‚:"
          ls -lt videos/*.mp4 videos/*.avi videos/*.mov videos/*.mkv videos/*.webm 2>/dev/null || echo "No video files found"
        fi
        
        echo "video-path=$VIDEO_PATH" >> $GITHUB_OUTPUT
        
    - name: Verify video file exists
      run: |
        VIDEO_PATH="${{ steps.detect-video.outputs.video-path }}"
        
        if [ ! -f "$VIDEO_PATH" ]; then
          echo "âŒ Video file not found: $VIDEO_PATH"
          exit 1
        fi
        echo "âœ… Video file found: $VIDEO_PATH"
        
        # Display video information
        echo "ğŸ“¹ Video details:"
        ls -la "$VIDEO_PATH"
        
        # Create analysis directory
        mkdir -p "${{ needs.setup-branch.outputs.folder-name }}/analysis"
        echo "âœ… Created analysis directory"
        
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: Install Python dependencies
      run: |
        pip install google-generativeai
        
    - name: ğŸ“Š å‹•ç”»åˆ†æ - æº–å‚™
      id: prepare-analysis
      run: |
        echo "Starting video analysis..."
        echo "Video path: ${{ steps.detect-video.outputs.video-path }}"
        echo "Output folder: ${{ needs.setup-branch.outputs.folder-name }}"
        mkdir -p "${{ needs.setup-branch.outputs.folder-name }}/analysis"
        
    - name: Load prompts from settings
      id: load-prompts
      run: |
        # ã‚¿ã‚¤ãƒˆãƒ«ç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’èª­ã¿è¾¼ã‚€
        TITLE_PROMPT=$(grep -A 100 "### ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ" settings/video-analysis-prompts.md | grep -A 1 "^\`\`\`$" | head -2 | tail -1)
        echo "title-prompt<<EOF" >> $GITHUB_OUTPUT
        echo "$TITLE_PROMPT" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
        # ãƒ†ã‚­ã‚¹ãƒˆã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’èª­ã¿è¾¼ã‚€
        OVERLAY_PROMPT=$(grep -A 100 "## 2. ãƒ†ã‚­ã‚¹ãƒˆã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ" settings/video-analysis-prompts.md | grep -A 100 "### ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ" | grep -A 1 "^\`\`\`$" | head -2 | tail -1)
        echo "overlay-prompt<<EOF" >> $GITHUB_OUTPUT
        echo "$OVERLAY_PROMPT" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
    - name: Load FFmpeg settings
      id: load-ffmpeg-settings
      run: |
        # YAMLè¨­å®šã‚’èª­ã¿è¾¼ã‚“ã§JSONå½¢å¼ã«å¤‰æ›
        pip install pyyaml
        
        cat > /tmp/load_settings.py << 'SCRIPT_EOF'
        import yaml
        import json
        
        with open('settings/ffmpeg-settings.yml', 'r') as f:
            settings = yaml.safe_load(f)
        
        # ã‚¿ã‚¤ãƒˆãƒ«è¨­å®šã‚’JSONå½¢å¼ã§å‡ºåŠ›
        title_settings = {'title': settings['title']}
        print('TITLE_SETTINGS_JSON<<EOF')
        print(json.dumps(title_settings))
        print('EOF')
        
        # ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤è¨­å®šã‚’JSONå½¢å¼ã§å‡ºåŠ›
        overlay_settings = {'text_overlay': settings['text_overlay']}
        print('OVERLAY_SETTINGS_JSON<<EOF')
        print(json.dumps(overlay_settings))
        print('EOF')
        SCRIPT_EOF
        
        python /tmp/load_settings.py >> $GITHUB_OUTPUT
        
    - name: ğŸ¯ ã‚¿ã‚¤ãƒˆãƒ«ç”Ÿæˆ
      id: generate-title
      env:
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      run: |
        set -e
        FOLDER_NAME="${{ needs.setup-branch.outputs.folder-name }}"
        
        # ã‚«ã‚¹ã‚¿ãƒ ã‚¿ã‚¤ãƒˆãƒ«ãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚‹å ´åˆ
        if [ -n "${{ github.event.inputs.edit_title }}" ]; then
          # è¨­å®šã‹ã‚‰å€¤ã‚’èª­ã¿è¾¼ã‚€
          TITLE_SETTINGS='${{ steps.load-ffmpeg-settings.outputs.TITLE_SETTINGS_JSON }}'
          DURATION=$(echo "$TITLE_SETTINGS" | jq -r '.title.duration')
          FONTSIZE=$(echo "$TITLE_SETTINGS" | jq -r '.title.default.fontsize')
          COLOR=$(echo "$TITLE_SETTINGS" | jq -r '.title.default.color')
          BGCOLOR=$(echo "$TITLE_SETTINGS" | jq -r '.title.default.bgcolor')
          FONTFILE=$(echo "$TITLE_SETTINGS" | jq -r '.title.default.fontfile')
          
          echo "{\"title\": \"${{ github.event.inputs.edit_title }}\", \"duration\": $DURATION, \"style\": {\"fontsize\": $FONTSIZE, \"color\": \"$COLOR\", \"bgcolor\": \"$BGCOLOR\", \"fontfile\": \"$FONTFILE\"}}" | jq . > "$FOLDER_NAME/analysis/title.json"
          echo "âœ… Using custom title: ${{ github.event.inputs.edit_title }}"
        else
          # Geminiã§ã‚¿ã‚¤ãƒˆãƒ«ç”Ÿæˆ  
          TITLE_PROMPT="${{ steps.load-prompts.outputs.title-prompt }}"
          
          # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒç©ºã§ãªã„ã“ã¨ã‚’ç¢ºèª
          if [ -z "$TITLE_PROMPT" ]; then
            echo "âŒ Title prompt is empty!"
            exit 1
          fi
          
          echo "ğŸ“ Using title prompt: $TITLE_PROMPT"
          
          # Geminiã‹ã‚‰ã‚¿ã‚¤ãƒˆãƒ«ã®ã¿å–å¾—
          python scripts/gemini_analyzer.py \
            "${{ steps.detect-video.outputs.video-path }}" \
            "$FOLDER_NAME/analysis/title_raw.txt" \
            "$GEMINI_API_KEY" \
            --prompt "$TITLE_PROMPT"
          
          # ã‚¿ã‚¤ãƒˆãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§å›ºå®šãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã®JSONã‚’ä½œæˆ
          if [ -f "$FOLDER_NAME/analysis/title_raw.txt" ]; then
            # æœ€åˆã®è¡Œã‚’å–å¾—ã—ã€ä½™åˆ†ãªæ–‡å­—ã‚’å‰Šé™¤
            GENERATED_TITLE=$(cat "$FOLDER_NAME/analysis/title_raw.txt" | head -1 | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' | sed 's/^["'\''ã€Œã€ã€ã€]*//;s/["'\''ã€Œã€ã€ã€]*$//')
            
            # ã‚¿ã‚¤ãƒˆãƒ«ãŒé•·ã™ãã‚‹å ´åˆã‚„ã€æ˜ã‚‰ã‹ã«é–“é•ã£ã¦ã„ã‚‹å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
            if [ ${#GENERATED_TITLE} -gt 30 ] || [[ "$GENERATED_TITLE" == *"æ‰¿çŸ¥"* ]] || [[ "$GENERATED_TITLE" == *"åˆ†æ"* ]]; then
              echo "âš ï¸ Invalid title detected, using fallback"
              GENERATED_TITLE="å‹•ç”»ç·¨é›†å®Œäº†"
            fi
            
            # è¨­å®šã‹ã‚‰å€¤ã‚’èª­ã¿è¾¼ã‚€
            TITLE_SETTINGS='${{ steps.load-ffmpeg-settings.outputs.TITLE_SETTINGS_JSON }}'
            DURATION=$(echo "$TITLE_SETTINGS" | jq -r '.title.duration')
            FONTSIZE=$(echo "$TITLE_SETTINGS" | jq -r '.title.default.fontsize')
            COLOR=$(echo "$TITLE_SETTINGS" | jq -r '.title.default.color')
            BGCOLOR=$(echo "$TITLE_SETTINGS" | jq -r '.title.default.bgcolor')
            FONTFILE=$(echo "$TITLE_SETTINGS" | jq -r '.title.default.fontfile')
            
            echo "{\"title\": \"$GENERATED_TITLE\", \"duration\": $DURATION, \"style\": {\"fontsize\": $FONTSIZE, \"color\": \"$COLOR\", \"bgcolor\": \"$BGCOLOR\", \"fontfile\": \"$FONTFILE\"}}" | jq . > "$FOLDER_NAME/analysis/title.json"
          else
            echo "âŒ Failed to generate title"
            exit 1
          fi
        fi
        
        # Verify title.json
        if [ -f "$FOLDER_NAME/analysis/title.json" ]; then
          echo "âœ… Title generated successfully (duration: 3 seconds)"
          cat "$FOLDER_NAME/analysis/title.json"
        else
          echo "âŒ Title generation failed"
          exit 1
        fi
        
    - name: ğŸ“ èª¬æ˜æ–‡ç”Ÿæˆ
      id: generate-descriptions
      env:
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      run: |
        set -e
        FOLDER_NAME="${{ needs.setup-branch.outputs.folder-name }}"
        TEXT_POSITION="${{ github.event.inputs.text_position }}"
        VIDEO_PATH="${{ steps.detect-video.outputs.video-path }}"
        
        # å‹•ç”»ã®é•·ã•ã‚’å–å¾—
        VIDEO_DURATION=$(ffprobe -v error -show_entries format=duration -of default=noprint_wrappers=1:nokey=1 "$VIDEO_PATH" | cut -d'.' -f1)
        echo "ğŸ“¹ Video duration: ${VIDEO_DURATION} seconds"
        
        # ãƒ†ã‚­ã‚¹ãƒˆä½ç½®ã®æ±ºå®šï¼ˆæ—¥æœ¬èªâ†’è‹±èªå¤‰æ›ï¼‰
        if [ "$TEXT_POSITION" = "auto" ] || [ -z "$TEXT_POSITION" ]; then
          POSITION="top-left"
        else
          case "$TEXT_POSITION" in
            "å·¦ä¸Š") POSITION="top-left" ;;
            "ä¸Š") POSITION="top-center" ;;
            "å³ä¸Š") POSITION="top-right" ;;
            "å·¦ä¸‹") POSITION="bottom-left" ;;
            "ä¸‹") POSITION="bottom-center" ;;
            "å³ä¸‹") POSITION="bottom-right" ;;
            *) POSITION="$TEXT_POSITION" ;;  # è‹±èªã®å ´åˆã¯ãã®ã¾ã¾ä½¿ç”¨
          esac
        fi
        
        # èª¬æ˜ç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä½œæˆ
        BASE_PROMPT_TEMPLATE="${{ steps.load-prompts.outputs.overlay-prompt }}"
        
        # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒç©ºã§ãªã„ã“ã¨ã‚’ç¢ºèª
        if [ -z "$BASE_PROMPT_TEMPLATE" ]; then
          echo "âŒ Overlay prompt template is empty!"
          exit 1
        fi
        
        # å¤‰æ•°ã‚’ç½®æ›
        BASE_PROMPT="${BASE_PROMPT_TEMPLATE//\${VIDEO_DURATION}/$VIDEO_DURATION}"
        BASE_PROMPT="${BASE_PROMPT//\${POSITION}/$POSITION}"
        
        # è¿½åŠ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒã‚ã‚‹å ´åˆ
        if [ -n "${{ github.event.inputs.description_prompt }}" ]; then
          FULL_PROMPT="$BASE_PROMPT è¿½åŠ ã®æŒ‡ç¤º: ${{ github.event.inputs.description_prompt }}"
        else
          FULL_PROMPT="$BASE_PROMPT"
        fi
        
        python scripts/gemini_analyzer.py \
          "${{ steps.detect-video.outputs.video-path }}" \
          "$FOLDER_NAME/analysis/descriptions.json" \
          "$GEMINI_API_KEY" \
          --prompt "$FULL_PROMPT" \
          --format json
        
        # ãƒ†ã‚­ã‚¹ãƒˆä½ç½®æƒ…å ±ã‚’ä¿å­˜
        echo "{\"position\": \"$POSITION\"}" > "$FOLDER_NAME/analysis/text-position.json"
        
        # ã‚µãƒãƒªãƒ¼ä½œæˆ
        echo "# Video Analysis Summary" > "$FOLDER_NAME/analysis/summary.md"
        echo "" >> "$FOLDER_NAME/analysis/summary.md"
        echo "## Generated Title" >> "$FOLDER_NAME/analysis/summary.md"
        TITLE=$(jq -r '.title' "$FOLDER_NAME/analysis/title.json")
        echo "- **Title**: $TITLE" >> "$FOLDER_NAME/analysis/summary.md"
        echo "" >> "$FOLDER_NAME/analysis/summary.md"
        echo "## Text Position" >> "$FOLDER_NAME/analysis/summary.md"
        echo "- **Position**: $POSITION" >> "$FOLDER_NAME/analysis/summary.md"
        echo "" >> "$FOLDER_NAME/analysis/summary.md"
        echo "## Analysis Completed" >> "$FOLDER_NAME/analysis/summary.md"
        echo "- **Date**: $(TZ=Asia/Tokyo date)" >> "$FOLDER_NAME/analysis/summary.md"
        
        echo "âœ… Analysis completed"
          
    - name: Verify analysis results
      id: verify
      run: |
        FOLDER_NAME="${{ needs.setup-branch.outputs.folder-name }}"
        
        # Debug: Check current directory and folder structure
        echo "ğŸ“ Current directory: $(pwd)"
        echo "ğŸ“ Checking for folder: $FOLDER_NAME"
        ls -la "$FOLDER_NAME/" || echo "Folder not found: $FOLDER_NAME"
        
        # ã‚¿ã‚¤ãƒˆãƒ«JSONã®ç¢ºèª
        if [ -f "$FOLDER_NAME/analysis/title.json" ]; then
          echo "ğŸ“„ title.json found, contents:"
          cat "$FOLDER_NAME/analysis/title.json"
          TITLE=$(jq -r '.title' "$FOLDER_NAME/analysis/title.json")
          echo "âœ… Title generated: $TITLE"
          echo "title=$TITLE" >> $GITHUB_OUTPUT
        else
          echo "âŒ Title file not found at: $FOLDER_NAME/analysis/title.json"
          echo "ğŸ“ Contents of $FOLDER_NAME:"
          ls -la "$FOLDER_NAME/" || echo "Folder not found"
          echo "ğŸ“ Contents of $FOLDER_NAME/analysis:"
          ls -la "$FOLDER_NAME/analysis/" || echo "Analysis folder not found"
          exit 1
        fi
        
        # èª¬æ˜JSONã®ç¢ºèª
        if [ -f "$FOLDER_NAME/analysis/descriptions.json" ]; then
          DESC_COUNT=$(jq '. | length' "$FOLDER_NAME/analysis/descriptions.json")
          echo "âœ… Descriptions generated: $DESC_COUNT items"
          
          # èª¬æ˜æ–‡ã®ã‚µãƒãƒªãƒ¼ã‚’ä½œæˆ
          DESCRIPTIONS_SUMMARY=$(jq -r '[.[] | .text] | join(", ")' "$FOLDER_NAME/analysis/descriptions.json")
          echo "descriptions-summary=$DESCRIPTIONS_SUMMARY" >> $GITHUB_OUTPUT
        else
          echo "âŒ Descriptions file not found"
          exit 1
        fi
        
        echo "completed=true" >> $GITHUB_OUTPUT
        
    - name: Commit analysis results
      run: |
        git config user.name "${{ env.GIT_USER_NAME }}"
        git config user.email "${{ env.GIT_USER_EMAIL }}"
        
        # Debug: Show what files were created
        echo "ğŸ“ Files in analysis directory:"
        ls -la "${{ needs.setup-branch.outputs.folder-name }}/analysis/" || echo "Analysis directory not found"
        
        # Add the specific folder
        git add "${{ needs.setup-branch.outputs.folder-name }}/"
        
        # Check git status
        echo "ğŸ“‹ Git status:"
        git status
        
        if git diff --cached --quiet; then
          echo "No analysis files to commit"
        else
          git commit -m "ğŸ“Š Add video analysis results - Video: ${{ steps.detect-video.outputs.video-path }}, Title: ${{ steps.verify.outputs.title }}, Analyzed at: $(TZ=Asia/Tokyo date)"
          git pull --rebase origin "${{ needs.setup-branch.outputs.branch-name }}"
          git push
        fi

  edit-video:
    runs-on: ubuntu-latest
    needs: [setup-branch, analyze-video]
    if: needs.analyze-video.outputs.analysis-completed == 'true'
    outputs:
      edited-video-path: ${{ steps.set-output.outputs.video-path }}
      
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        ref: ${{ needs.setup-branch.outputs.branch-name }}
        
    - name: Install FFmpeg and Fonts
      run: |
        sudo apt-get update
        sudo apt-get install -y ffmpeg
        # Install Japanese fonts for better text rendering
        sudo apt-get install -y fonts-noto-cjk fonts-ipafont-gothic fonts-ipafont-mincho
        ffmpeg -version
        fc-list | grep -i gothic || true
        
    - name: Create output directory
      run: |
        mkdir -p ${{ needs.setup-branch.outputs.folder-name }}/work-in-progress
        mkdir -p ${{ needs.setup-branch.outputs.folder-name }}/final-output
        
    - name: Get video resolution
      id: video-res
      run: |
        RESOLUTION=$(ffprobe -v error -select_streams v:0 -show_entries stream=width,height -of csv=s=x:p=0 "${{ needs.analyze-video.outputs.actual-video-path }}")
        echo "video_resolution=$RESOLUTION" >> $GITHUB_OUTPUT
        echo "Original video resolution: $RESOLUTION"

    - name: Read title data
      id: read-title
      run: |
        FOLDER_NAME="${{ needs.setup-branch.outputs.folder-name }}"
        TITLE_DATA=$(cat "$FOLDER_NAME/analysis/title.json")
        echo "title-data<<EOF" >> $GITHUB_OUTPUT
        echo "$TITLE_DATA" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: Generate title video
      uses: ./modules/ffmpeg-title-generator
      with:
        title: ${{ fromJson(steps.read-title.outputs.title-data).title }}
        duration: ${{ fromJson(steps.read-title.outputs.title-data).duration }}
        resolution: ${{ steps.video-res.outputs.video_resolution }}
        fontsize: ${{ fromJson(steps.read-title.outputs.title-data).style.fontsize }}
        color: ${{ fromJson(steps.read-title.outputs.title-data).style.color }}
        bgcolor: ${{ fromJson(steps.read-title.outputs.title-data).style.bgcolor }}
        fontfile: ${{ env.FONT_FILE }}
        output-path: ${{ needs.setup-branch.outputs.folder-name }}/work-in-progress/title.mp4
        
    - name: Apply text overlays
      uses: ./modules/ffmpeg-text-overlay
      with:
        video-path: ${{ needs.analyze-video.outputs.actual-video-path }}
        descriptions-json: ${{ needs.setup-branch.outputs.folder-name }}/analysis/descriptions.json
        fontfile: ${{ env.FONT_FILE }}
        output-path: ${{ needs.setup-branch.outputs.folder-name }}/work-in-progress/video_with_overlays.mp4
        
    - name: Combine title and video
      id: finalize
      uses: ./modules/ffmpeg-video-concat
      with:
        video1-path: ${{ needs.setup-branch.outputs.folder-name }}/work-in-progress/title.mp4
        video2-path: ${{ needs.setup-branch.outputs.folder-name }}/work-in-progress/video_with_overlays.mp4
        video1-duration: ${{ fromJson(steps.read-title.outputs.title-data).duration }}
        output-path: ${{ needs.setup-branch.outputs.folder-name }}/work-in-progress/basic-edited.mp4
        
    - name: Set output path and create report
      id: set-output
      run: |
        FOLDER_NAME="${{ needs.setup-branch.outputs.folder-name }}"
        echo "video-path=$FOLDER_NAME/work-in-progress/basic-edited.mp4" >> $GITHUB_OUTPUT
        
        # ãƒ¬ãƒãƒ¼ãƒˆä½œæˆ
        cat > "$FOLDER_NAME/work-in-progress/report.md" << EOF
        # å‹•ç”»ç·¨é›†ãƒ¬ãƒãƒ¼ãƒˆ
        
        ## ç·¨é›†å†…å®¹
        - **å…ƒå‹•ç”»**: ${{ needs.analyze-video.outputs.actual-video-path }}
        - **ã‚¿ã‚¤ãƒˆãƒ«**: ${{ needs.analyze-video.outputs.title }}
        - **ç·¨é›†æ—¥æ™‚**: $(TZ=Asia/Tokyo date)
        
        ## è¿½åŠ ã•ã‚ŒãŸè¦ç´ 
        1. ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢ï¼ˆå†’é ­3ç§’ï¼‰
        2. èª¬æ˜ãƒ†ã‚­ã‚¹ãƒˆã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼ˆ$(jq '. | length' "$FOLDER_NAME/analysis/descriptions.json")ç®‡æ‰€ï¼‰
        
        ## å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«
        - æœ€çµ‚å‹•ç”»: \`work-in-progress/basic-edited.mp4\`
        EOF
        
    - name: Move to final-output if no enhancements selected
      if: github.event.inputs.generate_title_image != 'true' && github.event.inputs.generate_background_music != 'true'
      run: |
        FOLDER_NAME="${{ needs.setup-branch.outputs.folder-name }}"
        echo "ğŸ“¦ No enhancements selected, moving basic edited video to final-output..."
        mkdir -p "$FOLDER_NAME/final-output"
        
        # Move video_with_overlays.mp4 to final-output
        if [ -f "$FOLDER_NAME/work-in-progress/video_with_overlays.mp4" ]; then
          mv "$FOLDER_NAME/work-in-progress/video_with_overlays.mp4" "$FOLDER_NAME/final-output/final-edited.mp4"
          echo "âœ… Moved to final-output/final-edited.mp4"
        else
          echo "âš ï¸ video_with_overlays.mp4 not found"
        fi
        
    - name: Commit edited video
      run: |
        git config user.name "${{ env.GIT_USER_NAME }}"
        git config user.email "${{ env.GIT_USER_EMAIL }}"
        git add --all -- ':!.gemini/'
        if git diff --cached --quiet; then
          echo "No edited files to commit"
        else
          git commit -m "ğŸ¬ Add edited video - Title: ${{ needs.analyze-video.outputs.title }}, Edited at: $(TZ=Asia/Tokyo date)"
          git pull --rebase origin "${{ needs.setup-branch.outputs.branch-name }}"
          git push
        fi

  generate-title-image:
    runs-on: ubuntu-latest
    needs: [setup-branch, analyze-video]
    if: needs.analyze-video.outputs.analysis-completed == 'true' && github.event.inputs.generate_title_image == 'true'
    outputs:
      image-generated: ${{ steps.generate.outputs.image-generated }}
      
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        ref: ${{ needs.setup-branch.outputs.branch-name }}
        
    - name: Load image generation prompt
      id: load-prompt
      run: |
        # ç”»åƒç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’èª­ã¿è¾¼ã‚€
        IMAGE_PROMPT_TEMPLATE=$(grep -A 100 "## ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ" settings/image-generation-prompt.md | grep -A 20 "^\`\`\`$" | head -21 | tail -20 | grep -v "^\`\`\`$")
        
        # å¤‰æ•°ã‚’ç½®æ›
        IMAGE_PROMPT="${IMAGE_PROMPT_TEMPLATE//\${TITLE}/${{ needs.analyze-video.outputs.title }}}"
        IMAGE_PROMPT="${IMAGE_PROMPT//\${FOLDER_NAME}/${{ needs.setup-branch.outputs.folder-name }}}"
        
        echo "image-prompt<<EOF" >> $GITHUB_OUTPUT
        echo "$IMAGE_PROMPT" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
    - name: Generate title image
      id: generate
      uses: ./modules/gemini-cli-title-image-generator
      with:
        branch-name: ${{ needs.setup-branch.outputs.branch-name }}
        folder-name: ${{ needs.setup-branch.outputs.folder-name }}
        output-path: 'title-image/background.jpg'
        commit-message: 'ğŸ–¼ï¸ Add generated title background image - Title: ${{ needs.analyze-video.outputs.title }}'
        generation-prompt: ${{ steps.load-prompt.outputs.image-prompt }}
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        T2I_KAMUI_IMAGEN4_FAST_URL: ${{ secrets.T2I_KAMUI_IMAGEN4_FAST_URL }}
        
    - name: Commit title image
      if: steps.generate.outputs.image-generated == 'true'
      run: |
        git config user.name "${{ env.GIT_USER_NAME }}"
        git config user.email "${{ env.GIT_USER_EMAIL }}"
        # .gemini/settings.jsonã‚’é™¤å¤–ã—ã¦ã‚³ãƒŸãƒƒãƒˆï¼ˆæ—¢ã«å­˜åœ¨ã™ã‚‹å ´åˆã®ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆã‚’é¿ã‘ã‚‹ï¼‰
        git add --all -- ':!.gemini/'
        if git diff --cached --quiet; then
          echo "No title image to commit"
        else
          git commit -m "${{ steps.generate.outputs.commit-message || 'ğŸ–¼ï¸ Add generated title background image' }} - Generated at: $(TZ=Asia/Tokyo date)"
          git pull --rebase origin "${{ needs.setup-branch.outputs.branch-name }}"
          git push
        fi

  generate-music:
    runs-on: ubuntu-latest
    needs: [setup-branch, analyze-video]
    if: needs.analyze-video.outputs.analysis-completed == 'true' && github.event.inputs.generate_background_music == 'true'
    outputs:
      music-generated: ${{ steps.generate.outputs.music-generated }}
      
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        ref: ${{ needs.setup-branch.outputs.branch-name }}
        
    - name: Load music generation prompt
      id: load-prompt
      run: |
        # éŸ³æ¥½ç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’èª­ã¿è¾¼ã‚€
        MUSIC_PROMPT_TEMPLATE=$(grep -A 100 "## ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ" settings/music-generation-prompt.md | grep -A 20 "^\`\`\`$" | head -21 | tail -20 | grep -v "^\`\`\`$")
        
        # å¤‰æ•°ã‚’ç½®æ›
        MUSIC_PROMPT="${MUSIC_PROMPT_TEMPLATE//\${TITLE}/${{ needs.analyze-video.outputs.title }}}"
        MUSIC_PROMPT="${MUSIC_PROMPT//\${DESCRIPTIONS_SUMMARY}/${{ needs.analyze-video.outputs.descriptions-summary }}}"
        MUSIC_PROMPT="${MUSIC_PROMPT//\${FOLDER_NAME}/${{ needs.setup-branch.outputs.folder-name }}}"
        
        echo "music-prompt<<EOF" >> $GITHUB_OUTPUT
        echo "$MUSIC_PROMPT" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
    - name: Generate music
      id: generate
      uses: ./modules/gemini-cli-music-generator
      with:
        branch-name: ${{ needs.setup-branch.outputs.branch-name }}
        folder-name: ${{ needs.setup-branch.outputs.folder-name }}
        output-path: 'music/background.wav'
        commit-message: 'ğŸµ Add generated background music - Title: ${{ needs.analyze-video.outputs.title }}'
        generation-prompt: ${{ steps.load-prompt.outputs.music-prompt }}
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        T2M_KAMUI_LYRIA_URL: ${{ secrets.T2M_KAMUI_LYRIA_URL }}
        
    - name: Commit music
      if: steps.generate.outputs.music-generated == 'true'
      run: |
        git config user.name "${{ env.GIT_USER_NAME }}"
        git config user.email "${{ env.GIT_USER_EMAIL }}"
        # .gemini/settings.jsonã‚’é™¤å¤–ã—ã¦ã‚³ãƒŸãƒƒãƒˆï¼ˆæ—¢ã«å­˜åœ¨ã™ã‚‹å ´åˆã®ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆã‚’é¿ã‘ã‚‹ï¼‰
        git add --all -- ':!.gemini/'
        if git diff --cached --quiet; then
          echo "No music to commit"
        else
          git commit -m "ğŸµ Add generated background music - Title: ${{ needs.analyze-video.outputs.title }}, Generated at: $(TZ=Asia/Tokyo date)"
          git pull --rebase origin "${{ needs.setup-branch.outputs.branch-name }}"
          git push
        fi


  integrate-final-video:
    runs-on: ubuntu-latest
    needs: [setup-branch, analyze-video, edit-video, generate-title-image, generate-music]
    if: |
      needs.analyze-video.outputs.analysis-completed == 'true' && 
      (github.event.inputs.generate_title_image == 'true' || github.event.inputs.generate_background_music == 'true') &&
      (!failure() && !cancelled())
    outputs:
      final-video-path: ${{ steps.finalize-enhanced.outputs.final-path }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        ref: ${{ needs.setup-branch.outputs.branch-name }}
        
    - name: Install FFmpeg and Fonts
      run: |
        sudo apt-get update
        sudo apt-get install -y ffmpeg bc
        # Install Japanese fonts for title rendering
        sudo apt-get install -y fonts-noto-cjk fonts-ipafont-gothic fonts-ipafont-mincho
        ffmpeg -version
        fc-list | grep -i noto || true
        
    - name: Read title data for final video
      id: read-title-final
      run: |
        FOLDER_NAME="${{ needs.setup-branch.outputs.folder-name }}"
        TITLE_DATA=$(cat "$FOLDER_NAME/analysis/title.json")
        echo "title-data<<EOF" >> $GITHUB_OUTPUT
        echo "$TITLE_DATA" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
    - name: Get video resolution
      id: video-res-final
      run: |
        RESOLUTION=$(ffprobe -v error -select_streams v:0 -show_entries stream=width,height -of csv=s=x:p=0 "${{ needs.analyze-video.outputs.actual-video-path }}")
        echo "video_resolution=$RESOLUTION" >> $GITHUB_OUTPUT
        
    - name: Generate enhanced title with background
      id: generate-enhanced-title
      if: needs.generate-title-image.outputs.image-generated == 'true'
      uses: ./modules/ffmpeg-title-generator
      with:
        title: ${{ fromJson(steps.read-title-final.outputs.title-data).title }}
        duration: ${{ fromJson(steps.read-title-final.outputs.title-data).duration }}
        resolution: ${{ steps.video-res-final.outputs.video_resolution }}
        fontsize: ${{ fromJson(steps.read-title-final.outputs.title-data).style.fontsize }}
        color: ${{ fromJson(steps.read-title-final.outputs.title-data).style.color }}
        bgcolor: ${{ fromJson(steps.read-title-final.outputs.title-data).style.bgcolor }}
        fontfile: ${{ env.FONT_FILE }}
        background-image: ${{ needs.setup-branch.outputs.folder-name }}/title-image/background.jpg
        output-path: ${{ needs.setup-branch.outputs.folder-name }}/work-in-progress/title_with_bg.mp4
        
    - name: Combine enhanced title with video
      id: combine-enhanced
      if: needs.generate-title-image.outputs.image-generated == 'true'
      uses: ./modules/ffmpeg-video-concat
      with:
        video1-path: ${{ needs.setup-branch.outputs.folder-name }}/work-in-progress/title_with_bg.mp4
        video2-path: ${{ needs.setup-branch.outputs.folder-name }}/work-in-progress/video_with_overlays.mp4
        video1-duration: ${{ fromJson(steps.read-title-final.outputs.title-data).duration }}
        output-path: ${{ needs.setup-branch.outputs.folder-name }}/work-in-progress/video_enhanced.mp4
        
    - name: Generate enhanced video with background and music
      id: finalize-enhanced
      run: |
        FOLDER_NAME="${{ needs.setup-branch.outputs.folder-name }}"
        
        # å…ƒã®ãƒ“ãƒ‡ã‚ªãƒ•ã‚¡ã‚¤ãƒ«åã‚’å–å¾—ï¼ˆãƒ‘ã‚¹ã¨extensionã‚’é™¤å»ï¼‰
        ORIGINAL_VIDEO="${{ needs.analyze-video.outputs.actual-video-path }}"
        VIDEO_BASENAME=$(basename "$ORIGINAL_VIDEO" | sed 's/\.[^.]*$//')
        
        # ä½¿ç”¨ã™ã‚‹å‹•ç”»ã‚’æ±ºå®šï¼ˆèƒŒæ™¯ç”»åƒãŒã‚ã‚Œã°å¼·åŒ–ç‰ˆã€ãªã‘ã‚Œã°é€šå¸¸ç‰ˆï¼‰
        if [ "${{ needs.generate-title-image.outputs.image-generated }}" = "true" ]; then
          echo "ğŸ–¼ï¸ Using enhanced title with background image"
            
          # ã‚ªãƒªã‚¸ãƒŠãƒ«ã®å‹•ç”»ï¼ˆã‚¿ã‚¤ãƒˆãƒ«ãªã—ï¼‰ã‹ã‚‰å‹•ç”»éƒ¨åˆ†ã‚’å–å¾—
          # video_with_overlays.mp4ã‚’ä½¿ç”¨ï¼ˆã“ã‚Œã¯ã‚¿ã‚¤ãƒˆãƒ«ãªã—ã®å‹•ç”»ï¼‰
          
          VIDEO_FOR_MUSIC="$FOLDER_NAME/work-in-progress/video_enhanced.mp4"
        else
          echo "ğŸ“¹ Using standard video"
          VIDEO_FOR_MUSIC="$FOLDER_NAME/work-in-progress/basic-edited.mp4"
        fi
        
        # éŸ³æ¥½ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¢ã™
        if [ "${{ needs.generate-music.outputs.music-generated }}" = "true" ]; then
          if [ -f "$FOLDER_NAME/music/background.mp3" ]; then
            MUSIC_FILE="$FOLDER_NAME/music/background.mp3"
          elif [ -f "$FOLDER_NAME/music/background.wav" ]; then
            MUSIC_FILE="$FOLDER_NAME/music/background.wav"
          else
            echo "âš ï¸ Music file not found!"
            exit 1
          fi
          echo "music-file=$MUSIC_FILE" >> $GITHUB_OUTPUT
        fi
        
        # æœ€çµ‚å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«åã‚’è¨­å®š
        mkdir -p $FOLDER_NAME/final-output
        FINAL_OUTPUT="$FOLDER_NAME/final-output/${VIDEO_BASENAME}-final-edited.mp4"
        echo "final-path=$FINAL_OUTPUT" >> $GITHUB_OUTPUT
        echo "video-for-music=$VIDEO_FOR_MUSIC" >> $GITHUB_OUTPUT
        
    - name: Add background music
      id: add-music
      if: needs.generate-music.outputs.music-generated == 'true'
      uses: ./modules/ffmpeg-add-music
      with:
        video-path: ${{ steps.finalize-enhanced.outputs.video-for-music }}
        music-path: ${{ steps.finalize-enhanced.outputs.music-file }}
        volume: '0.3'
        output-path: ${{ steps.finalize-enhanced.outputs.final-path }}
        
    - name: Copy video without music
      if: needs.generate-music.outputs.music-generated != 'true'
      run: |
        cp "${{ steps.finalize-enhanced.outputs.video-for-music }}" "${{ steps.finalize-enhanced.outputs.final-path }}"
        echo "âœ… Final video copied without music"
        
    - name: Commit enhanced video
      run: |
        # æœ€çµ‚æˆæœç‰©ã‚’å°‚ç”¨ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã‚³ãƒ”ãƒ¼
        FOLDER_NAME="${{ needs.setup-branch.outputs.folder-name }}"
        VIDEO_BASENAME="$(basename "${{ needs.analyze-video.outputs.actual-video-path }}" .mp4)"
        
        if [ -f "$FOLDER_NAME/work-in-progress/${VIDEO_BASENAME}-final-edited.mp4" ]; then
          echo "ğŸ“¦ Organizing final output..."
          cp "$FOLDER_NAME/work-in-progress/${VIDEO_BASENAME}-final-edited.mp4" "$FOLDER_NAME/final-output/"
        # basic-edited.mp4ã¯work-in-progressã«ä¿æŒã•ã‚Œã‚‹ãŸã‚ã€final-outputã«ã¯ã‚³ãƒ”ãƒ¼ã—ãªã„
        fi
        
        git config user.name "${{ env.GIT_USER_NAME }}"
        git config user.email "${{ env.GIT_USER_EMAIL }}"
        git add --all -- ':!.gemini/'
        if git diff --cached --quiet; then
          echo "No enhanced video to commit"
        else
          git commit -m "ğŸ¬ Add enhanced video with title background - Title: ${{ needs.analyze-video.outputs.title }}, Enhanced at: $(TZ=Asia/Tokyo date)"
          git pull --rebase origin "${{ needs.setup-branch.outputs.branch-name }}"
          git push
        fi

  create-pull-request:
    runs-on: ubuntu-latest
    needs: [setup-branch, analyze-video, edit-video, generate-title-image, generate-music, integrate-final-video]
    if: always()
    
    steps:
    - uses: actions/checkout@v4
      with:
        ref: ${{ needs.setup-branch.outputs.branch-name }}
        token: ${{ secrets.PAT_TOKEN || github.token }}
        
    - name: Create Pull Request
      continue-on-error: true
      run: |
        gh pr create \
          --title "ğŸ¬ Video Edit: ${{ needs.analyze-video.outputs.title }}" \
          --body "$(cat <<'EOF'
        ## Summary
        Analyzed and edited video with AI-generated title and explanatory overlays.
        
        ## Input
        - **Video**: ${{ needs.analyze-video.outputs.actual-video-path }}
        - **Custom Title**: ${{ github.event.inputs.edit_title }}
        
        ## Processing Pipeline
        1. ğŸ“Š **Analysis**: Gemini Vision analyzed video content
        2. ğŸ¯ **Title**: Generated/used title "${{ needs.analyze-video.outputs.title }}"
        3. ğŸ“ **Overlays**: Added explanatory text at key moments
        4. ğŸ¬ **Edit**: Combined with FFmpeg (fade effects included)
        
        ## Generated Files
        - ğŸ“Š Analysis: `analysis/` directory
        - ğŸ–¼ï¸ Title Image: `title-image/` directory
        - ğŸµ Music: `music/` directory
        - ğŸ¬ Edited Videos: 
          - `work-in-progress/basic-edited.mp4` (standard)
          - `final-output/[original-filename]-final-edited.mp4` (with AI background and music)
        - ğŸ“ Reports: `work-in-progress/report.md`, `README.md`
        
        ## Workflow Status
        - âœ… Video Analysis: Completed
        - âœ… Title Generation: Completed
        - âœ… Video Editing: Completed with FFmpeg
        - ${{ needs.generate-title-image.outputs.image-generated == 'true' && 'âœ…' || 'âš ï¸' }} Title Image Generation: ${{ needs.generate-title-image.outputs.image-generated == 'true' && 'Completed' || 'Skipped/Failed' }}
        - ${{ needs.generate-music.outputs.music-generated == 'true' && 'âœ…' || 'âš ï¸' }} Music Generation: ${{ needs.generate-music.outputs.music-generated == 'true' && 'Completed' || 'Skipped/Failed' }}
        - ${{ (needs.generate-title-image.outputs.image-generated == 'true' || needs.generate-music.outputs.music-generated == 'true') && 'âœ…' || 'âš ï¸' }} Enhanced Video: ${{ (needs.generate-title-image.outputs.image-generated == 'true' || needs.generate-music.outputs.music-generated == 'true') && 'Generated' || 'Skipped' }}
        EOF
        )" \
          --head "${{ needs.setup-branch.outputs.branch-name }}" \
          --base main
      env:
        GH_TOKEN: ${{ secrets.PAT_TOKEN }}
        
    - name: Create PR Summary (No PAT)
      if: failure()
      run: |
        echo "âš ï¸ Pull Request creation skipped - PAT_TOKEN not configured"
        echo "To enable automatic PR creation, please add a Personal Access Token with 'repo' and 'pull_request' permissions as PAT_TOKEN in repository secrets."
        echo ""
        echo "Branch created: ${{ needs.setup-branch.outputs.branch-name }}"
        echo "You can manually create a PR from this branch."
