name: Video Text Enhancer

on:
  workflow_dispatch:
    inputs:
      video_path:
        description: 'ÂàÜÊûêÂØæË±°„ÅÆÂãïÁîª„Éï„Ç°„Ç§„É´„Éë„ÇπÔºà„É™„Éù„Ç∏„Éà„É™ÂÜÖ„ÅÆÁõ∏ÂØæ„Éë„ÇπÔºâ„ÄÇauto-select„ÅØvideos„Éá„Ç£„É¨„ÇØ„Éà„É™„ÅÆÊúÄÊñ∞„ÅÆÂãïÁîª„ÇíÈÅ∏Êäû'
        required: true
        type: string
        default: 'auto-select'
      edit_title:
        description: 'ÂãïÁîª„Çø„Ç§„Éà„É´ÔºàÁúÅÁï•ÊôÇ„ÅØËá™ÂãïÁîüÊàêÔºâ'
        required: false
        type: string
      description_prompt:
        description: 'Ë™¨ÊòéÊñáÁîüÊàêÊôÇ„ÅÆËøΩÂä†„Éó„É≠„É≥„Éó„ÉàÔºà‰ªªÊÑèÔºâ'
        required: false
        type: string
      text_position:
        description: '„ÉÜ„Ç≠„Çπ„Éà„ÅÆË°®Á§∫‰ΩçÁΩÆ'
        required: false
        type: choice
        default: 'auto'
        options:
          - 'auto'
          - 'Â∑¶‰∏ä'
          - '‰∏ä'
          - 'Âè≥‰∏ä'
          - 'Â∑¶‰∏ã'
          - '‰∏ã'
          - 'Âè≥‰∏ã'

permissions:
  contents: write
  pull-requests: write

env:
  GIT_USER_NAME: "github-actions[bot]"
  GIT_USER_EMAIL: "github-actions[bot]@users.noreply.github.com"
  FONT_FILE: "/usr/share/fonts/opentype/noto/NotoSansCJK-Regular.ttc"

jobs:
  setup-branch:
    runs-on: ubuntu-latest
    outputs:
      branch-name: ${{ steps.branch.outputs.branch-name }}
      folder-name: ${{ steps.branch.outputs.folder-name }}
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.PAT_TOKEN || github.token }}
        
    - name: Create branch name
      id: branch
      run: |
        TIMESTAMP=$(date +%Y%m%d-%H%M%S)
        BRANCH_NAME="video-edit-$TIMESTAMP"
        FOLDER_NAME="movie-edit-$TIMESTAMP"
        echo "branch-name=$BRANCH_NAME" >> $GITHUB_OUTPUT
        echo "folder-name=$FOLDER_NAME" >> $GITHUB_OUTPUT
        
    - name: Create and switch to new branch
      run: |
        git config --global user.name "${{ env.GIT_USER_NAME }}"
        git config --global user.email "${{ env.GIT_USER_EMAIL }}"
        git checkout -b "${{ steps.branch.outputs.branch-name }}"
        git push -u origin "${{ steps.branch.outputs.branch-name }}"

  analyze-video:
    runs-on: ubuntu-latest
    needs: setup-branch
    outputs:
      title: ${{ steps.verify.outputs.title }}
      analysis-completed: ${{ steps.verify.outputs.completed }}
      descriptions-summary: ${{ steps.verify.outputs.descriptions-summary }}
      actual-video-path: ${{ steps.detect-video.outputs.video-path }}
      
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        ref: ${{ needs.setup-branch.outputs.branch-name }}
        
    - name: Detect video file
      id: detect-video
      run: |
        VIDEO_PATH="${{ github.event.inputs.video_path }}"
        
        # If auto-select is specified, find the most recently updated video
        if [ "$VIDEO_PATH" = "auto-select" ]; then
          echo "üîç Ëá™ÂãïÈÅ∏Êäû„É¢„Éº„Éâ: videos„Éá„Ç£„É¨„ÇØ„Éà„É™„Åã„ÇâÊúÄÊñ∞„ÅÆÂãïÁîª„ÇíÊ§úÁ¥¢‰∏≠..."
          
          # Find the most recently modified video file in the videos directory
          echo "üìÇ videos„Éá„Ç£„É¨„ÇØ„Éà„É™„ÅÆÂÜÖÂÆπ:"
          ls -la videos/ || true
          
          # Use git log to find the most recently committed video file
          echo "üîç Git„ÅÆÂ±•Ê≠¥„Åã„ÇâÊúÄÊñ∞„ÅÆÂãïÁîª„Éï„Ç°„Ç§„É´„ÇíÊ§úÁ¥¢‰∏≠..."
          
          # Show recent commits for videos
          echo "üìã ÊúÄËøë„ÅÆ„Éì„Éá„Ç™„Éï„Ç°„Ç§„É´„ÅÆ„Ç≥„Éü„ÉÉ„ÉàÂ±•Ê≠¥:"
          git log --oneline --name-only --pretty=format:"%h %ad %s" --date=short -- 'videos/*' | head -20 || true
          
          # Get the most recently committed video file from git history
          LATEST_VIDEO=$(git log --name-only --pretty=format: -- 'videos/*.mp4' 'videos/*.avi' 'videos/*.mov' 'videos/*.mkv' 'videos/*.webm' | grep -E '\.(mp4|avi|mov|mkv|webm)$' | head -1)
          
          # If no video found in git history, fall back to ls
          if [ -z "$LATEST_VIDEO" ]; then
            echo "‚ö†Ô∏è GitÂ±•Ê≠¥„Åã„ÇâÊ§úÂá∫„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ„Éï„Ç°„Ç§„É´„Ç∑„Çπ„ÉÜ„É†„Åã„ÇâÊ§úÁ¥¢„Åó„Åæ„Åô..."
            LATEST_VIDEO=$(ls videos/*.mp4 videos/*.avi videos/*.mov videos/*.mkv videos/*.webm 2>/dev/null | head -1)
          fi
          
          if [ -z "$LATEST_VIDEO" ]; then
            echo "‚ùå videos„Éá„Ç£„É¨„ÇØ„Éà„É™„Å´ÂãïÁîª„Éï„Ç°„Ç§„É´„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì"
            exit 1
          fi
          
          VIDEO_PATH="$LATEST_VIDEO"
          echo "‚úÖ ÊúÄÊñ∞„ÅÆÂãïÁîª„ÇíÊ§úÂá∫„Åó„Åæ„Åó„Åü: $VIDEO_PATH"
          echo "üìπ ÈÅ∏Êäû„Åï„Çå„ÅüÂãïÁîª: $VIDEO_PATH"
          
          # ÂãïÁîª„ÅÆÊõ¥Êñ∞Êó•ÊôÇ„ÇÇË°®Á§∫ÔºàË§áÊï∞„ÅÆÊñπÊ≥ï„ÇíË©¶„ÅôÔºâ
          if command -v stat >/dev/null 2>&1; then
            # GNU stat (Linux)
            VIDEO_DATE=$(stat -c "%y" "$VIDEO_PATH" 2>/dev/null)
            if [ -z "$VIDEO_DATE" ]; then
              # BSD stat (macOS)
              VIDEO_DATE=$(stat -f "%Sm" -t "%Y-%m-%d %H:%M:%S" "$VIDEO_PATH" 2>/dev/null)
            fi
          fi
          
          if [ -n "$VIDEO_DATE" ]; then
            echo "üìÖ Êõ¥Êñ∞Êó•ÊôÇ: $VIDEO_DATE"
          fi
          
          # „Éá„Éê„ÉÉ„Ç∞ÊÉÖÂ†±ÔºöÂÖ®ÂãïÁîª„Éï„Ç°„Ç§„É´„ÅÆÊõ¥Êñ∞Êó•ÊôÇ„ÇíË°®Á§∫
          echo "üîç ÂÖ®ÂãïÁîª„Éï„Ç°„Ç§„É´„ÅÆÊõ¥Êñ∞Êó•ÊôÇ:"
          ls -lt videos/*.mp4 videos/*.avi videos/*.mov videos/*.mkv videos/*.webm 2>/dev/null || echo "No video files found"
        fi
        
        echo "video-path=$VIDEO_PATH" >> $GITHUB_OUTPUT
        
    - name: Verify video file exists
      run: |
        VIDEO_PATH="${{ steps.detect-video.outputs.video-path }}"
        
        if [ ! -f "$VIDEO_PATH" ]; then
          echo "‚ùå Video file not found: $VIDEO_PATH"
          exit 1
        fi
        echo "‚úÖ Video file found: $VIDEO_PATH"
        
        # Display video information
        echo "üìπ Video details:"
        ls -la "$VIDEO_PATH"
        
        # Create analysis directory
        mkdir -p "${{ needs.setup-branch.outputs.folder-name }}/analysis"
        echo "‚úÖ Created analysis directory"
        
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: Install Python dependencies
      run: |
        pip install google-generativeai
        
    - name: üìä ÂãïÁîªÂàÜÊûê - Ê∫ñÂÇô
      id: prepare-analysis
      run: |
        echo "Starting video analysis..."
        echo "Video path: ${{ steps.detect-video.outputs.video-path }}"
        echo "Output folder: ${{ needs.setup-branch.outputs.folder-name }}"
        mkdir -p "${{ needs.setup-branch.outputs.folder-name }}/analysis"
        
    - name: üéØ „Çø„Ç§„Éà„É´ÁîüÊàê
      id: generate-title
      env:
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      run: |
        set -e
        FOLDER_NAME="${{ needs.setup-branch.outputs.folder-name }}"
        
        # „Ç´„Çπ„Çø„É†„Çø„Ç§„Éà„É´„ÅåÊåáÂÆö„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà
        if [ -n "${{ github.event.inputs.edit_title }}" ]; then
          echo '{"title": "${{ github.event.inputs.edit_title }}", "duration": 3, "style": {"fontsize": 72, "color": "white", "bgcolor": "black@0.8", "fontfile": "/usr/share/fonts/opentype/noto/NotoSansCJK-Regular.ttc"}}' | jq . > "$FOLDER_NAME/analysis/title.json"
          echo "‚úÖ Using custom title: ${{ github.event.inputs.edit_title }}"
        else
          # Gemini„Åß„Çø„Ç§„Éà„É´ÁîüÊàê
          echo '{"prompt": "„Åì„ÅÆÂãïÁîª„ÇíÂàÜÊûê„Åó„Å¶„ÄÅÈ≠ÖÂäõÁöÑ„Å™„Çø„Ç§„Éà„É´„ÇíÁîüÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ‰ª•‰∏ã„ÅÆJSONÂΩ¢Âºè„ÅßËøî„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºö{\"title\": \"ÁîüÊàê„Åï„Çå„Åü„Çø„Ç§„Éà„É´Ôºà20ÊñáÂ≠ó‰ª•ÂÜÖÔºâ\", \"duration\": 3, \"style\": {\"fontsize\": 72, \"color\": \"white\", \"bgcolor\": \"black@0.8\", \"fontfile\": \"/usr/share/fonts/opentype/noto/NotoSansCJK-Regular.ttc\"}}"}' > /tmp/title_prompt.json
          TITLE_PROMPT=$(jq -r '.prompt' /tmp/title_prompt.json)
          
          python scripts/gemini_analyzer.py \
            "${{ steps.detect-video.outputs.video-path }}" \
            "$FOLDER_NAME/analysis/title.json" \
            "$GEMINI_API_KEY" \
            --prompt "$TITLE_PROMPT" \
            --format json
        fi
        
        # Verify title.json
        if [ -f "$FOLDER_NAME/analysis/title.json" ]; then
          echo "‚úÖ Title generated successfully"
          cat "$FOLDER_NAME/analysis/title.json"
        else
          echo "‚ùå Title generation failed"
          exit 1
        fi
        
    - name: üìù Ë™¨ÊòéÊñáÁîüÊàê
      id: generate-descriptions
      env:
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      run: |
        set -e
        FOLDER_NAME="${{ needs.setup-branch.outputs.folder-name }}"
        TEXT_POSITION="${{ github.event.inputs.text_position }}"
        
        # „ÉÜ„Ç≠„Çπ„Éà‰ΩçÁΩÆ„ÅÆÊ±∫ÂÆö
        if [ "$TEXT_POSITION" = "auto" ] || [ -z "$TEXT_POSITION" ]; then
          POSITION="top-left"
        else
          POSITION="$TEXT_POSITION"
        fi
        
        # Ë™¨ÊòéÁîüÊàê„Éó„É≠„É≥„Éó„Éà„Çí‰ΩúÊàê
        BASE_PROMPT="ÂãïÁîª„ÅÆÂÜÖÂÆπ„ÇíÂàÜÊûê„Åó„Å¶„ÄÅÈáçË¶Å„Å™„Ç∑„Éº„É≥„Å´Ë™¨Êòé„ÉÜ„Ç≠„Çπ„Éà„ÇíËøΩÂä†„Åô„Çã„Åü„ÇÅ„ÅÆÊÉÖÂ†±„ÇíÁîüÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ„Çø„Ç§„Éü„É≥„Ç∞ÈÅ∏ÂÆöÂü∫Ê∫ñÔºö1. „Ç∑„Éº„É≥„ÅÆÂàá„ÇäÊõø„Çè„Çä„ÇÑÊñ∞„Åó„ÅÑË¶ÅÁ¥†„ÅåÁôªÂ†¥„Åô„Çã„Çø„Ç§„Éü„É≥„Ç∞ 2. ÈáçË¶Å„Å™„Ç¢„ÇØ„Ç∑„Éß„É≥„ÇÑÂ§âÂåñ„ÅåËµ∑„Åç„Çã„Çø„Ç§„Éü„É≥„Ç∞ 3. Ë¶ñËÅ¥ËÄÖ„Å´Ë™¨Êòé„ÅåÂøÖË¶Å„Å®ÊÄù„Çè„Çå„Çã„Çø„Ç§„Éü„É≥„Ç∞ 4. Ââç„ÅÆ„ÉÜ„Ç≠„Çπ„Éà„Åã„ÇâÊúÄ‰Ωé2Áßí‰ª•‰∏ä„ÅÆÈñìÈöî„ÇíÁ©∫„Åë„Çã„ÄÇJSONÈÖçÂàóÂΩ¢Âºè„ÅßËøî„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºö[{\"timestamp\": \"MM:SS\", \"text\": \"Ë™¨Êòé„ÉÜ„Ç≠„Çπ„ÉàÔºà30ÊñáÂ≠ó‰ª•ÂÜÖÔºâ\", \"duration\": 6, \"fontsize\": 48, \"position\": \"$POSITION\"}, ...]"
        
        # ËøΩÂä†„Éó„É≠„É≥„Éó„Éà„Åå„ÅÇ„ÇãÂ†¥Âêà
        if [ -n "${{ github.event.inputs.description_prompt }}" ]; then
          FULL_PROMPT="$BASE_PROMPT ËøΩÂä†„ÅÆÊåáÁ§∫: ${{ github.event.inputs.description_prompt }}"
        else
          FULL_PROMPT="$BASE_PROMPT"
        fi
        
        python scripts/gemini_analyzer.py \
          "${{ steps.detect-video.outputs.video-path }}" \
          "$FOLDER_NAME/analysis/descriptions.json" \
          "$GEMINI_API_KEY" \
          --prompt "$FULL_PROMPT" \
          --format json
        
        # „ÉÜ„Ç≠„Çπ„Éà‰ΩçÁΩÆÊÉÖÂ†±„Çí‰øùÂ≠ò
        echo "{\"position\": \"$POSITION\"}" > "$FOLDER_NAME/analysis/text-position.json"
        
        # „Çµ„Éû„É™„Éº‰ΩúÊàê
        echo "# Video Analysis Summary" > "$FOLDER_NAME/analysis/summary.md"
        echo "" >> "$FOLDER_NAME/analysis/summary.md"
        echo "## Generated Title" >> "$FOLDER_NAME/analysis/summary.md"
        TITLE=$(jq -r '.title' "$FOLDER_NAME/analysis/title.json")
        echo "- **Title**: $TITLE" >> "$FOLDER_NAME/analysis/summary.md"
        echo "" >> "$FOLDER_NAME/analysis/summary.md"
        echo "## Text Position" >> "$FOLDER_NAME/analysis/summary.md"
        echo "- **Position**: $POSITION" >> "$FOLDER_NAME/analysis/summary.md"
        echo "" >> "$FOLDER_NAME/analysis/summary.md"
        echo "## Analysis Completed" >> "$FOLDER_NAME/analysis/summary.md"
        echo "- **Date**: $(date)" >> "$FOLDER_NAME/analysis/summary.md"
        
        echo "‚úÖ Analysis completed"
          
    - name: Verify analysis results
      id: verify
      run: |
        FOLDER_NAME="${{ needs.setup-branch.outputs.folder-name }}"
        
        # Debug: Check current directory and folder structure
        echo "üìç Current directory: $(pwd)"
        echo "üìÅ Checking for folder: $FOLDER_NAME"
        ls -la "$FOLDER_NAME/" || echo "Folder not found: $FOLDER_NAME"
        
        # „Çø„Ç§„Éà„É´JSON„ÅÆÁ¢∫Ë™ç
        if [ -f "$FOLDER_NAME/analysis/title.json" ]; then
          echo "üìÑ title.json found, contents:"
          cat "$FOLDER_NAME/analysis/title.json"
          TITLE=$(jq -r '.title' "$FOLDER_NAME/analysis/title.json")
          echo "‚úÖ Title generated: $TITLE"
          echo "title=$TITLE" >> $GITHUB_OUTPUT
        else
          echo "‚ùå Title file not found at: $FOLDER_NAME/analysis/title.json"
          echo "üìÅ Contents of $FOLDER_NAME:"
          ls -la "$FOLDER_NAME/" || echo "Folder not found"
          echo "üìÅ Contents of $FOLDER_NAME/analysis:"
          ls -la "$FOLDER_NAME/analysis/" || echo "Analysis folder not found"
          exit 1
        fi
        
        # Ë™¨ÊòéJSON„ÅÆÁ¢∫Ë™ç
        if [ -f "$FOLDER_NAME/analysis/descriptions.json" ]; then
          DESC_COUNT=$(jq '. | length' "$FOLDER_NAME/analysis/descriptions.json")
          echo "‚úÖ Descriptions generated: $DESC_COUNT items"
          
          # Ë™¨ÊòéÊñá„ÅÆ„Çµ„Éû„É™„Éº„Çí‰ΩúÊàê
          DESCRIPTIONS_SUMMARY=$(jq -r '[.[] | .text] | join(", ")' "$FOLDER_NAME/analysis/descriptions.json")
          echo "descriptions-summary=$DESCRIPTIONS_SUMMARY" >> $GITHUB_OUTPUT
        else
          echo "‚ùå Descriptions file not found"
          exit 1
        fi
        
        echo "completed=true" >> $GITHUB_OUTPUT
        
    - name: Commit analysis results
      run: |
        git config user.name "${{ env.GIT_USER_NAME }}"
        git config user.email "${{ env.GIT_USER_EMAIL }}"
        
        # Debug: Show what files were created
        echo "üìÅ Files in analysis directory:"
        ls -la "${{ needs.setup-branch.outputs.folder-name }}/analysis/" || echo "Analysis directory not found"
        
        # Add the specific folder
        git add "${{ needs.setup-branch.outputs.folder-name }}/"
        
        # Check git status
        echo "üìã Git status:"
        git status
        
        if git diff --cached --quiet; then
          echo "No analysis files to commit"
        else
          git commit -m "üìä Add video analysis results - Video: ${{ steps.detect-video.outputs.video-path }}, Title: ${{ steps.verify.outputs.title }}, Analyzed at: $(date)"
          git pull --rebase origin "${{ needs.setup-branch.outputs.branch-name }}"
          git push
        fi

  edit-video:
    runs-on: ubuntu-latest
    needs: [setup-branch, analyze-video]
    if: needs.analyze-video.outputs.analysis-completed == 'true'
    outputs:
      edited-video-path: ${{ steps.set-output.outputs.video-path }}
      
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        ref: ${{ needs.setup-branch.outputs.branch-name }}
        
    - name: Install FFmpeg and Fonts
      run: |
        sudo apt-get update
        sudo apt-get install -y ffmpeg
        # Install Japanese fonts for better text rendering
        sudo apt-get install -y fonts-noto-cjk fonts-ipafont-gothic fonts-ipafont-mincho
        ffmpeg -version
        fc-list | grep -i gothic || true
        
    - name: Create output directory
      run: |
        mkdir -p ${{ needs.setup-branch.outputs.folder-name }}/edited-movie
        
    - name: Get video resolution
      id: video-res
      run: |
        RESOLUTION=$(ffprobe -v error -select_streams v:0 -show_entries stream=width,height -of csv=s=x:p=0 "${{ needs.analyze-video.outputs.actual-video-path }}")
        echo "video_resolution=$RESOLUTION" >> $GITHUB_OUTPUT
        echo "Original video resolution: $RESOLUTION"

    - name: Read title data
      id: read-title
      run: |
        FOLDER_NAME="${{ needs.setup-branch.outputs.folder-name }}"
        TITLE_DATA=$(cat "$FOLDER_NAME/analysis/title.json")
        echo "title-data<<EOF" >> $GITHUB_OUTPUT
        echo "$TITLE_DATA" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: Generate title video
      uses: ./modules/ffmpeg-title-generator
      with:
        title: ${{ fromJson(steps.read-title.outputs.title-data).title }}
        duration: ${{ fromJson(steps.read-title.outputs.title-data).duration }}
        resolution: ${{ steps.video-res.outputs.video_resolution }}
        fontsize: ${{ fromJson(steps.read-title.outputs.title-data).style.fontsize }}
        color: ${{ fromJson(steps.read-title.outputs.title-data).style.color }}
        bgcolor: ${{ fromJson(steps.read-title.outputs.title-data).style.bgcolor }}
        fontfile: ${{ env.FONT_FILE }}
        output-path: ${{ needs.setup-branch.outputs.folder-name }}/edited-movie/title.mp4
        
    - name: Apply text overlays
      uses: ./modules/ffmpeg-text-overlay
      with:
        video-path: ${{ needs.analyze-video.outputs.actual-video-path }}
        descriptions-json: ${{ needs.setup-branch.outputs.folder-name }}/analysis/descriptions.json
        fontfile: ${{ env.FONT_FILE }}
        output-path: ${{ needs.setup-branch.outputs.folder-name }}/edited-movie/video_with_overlays.mp4
        
    - name: Combine title and video
      id: finalize
      uses: ./modules/ffmpeg-video-concat
      with:
        video1-path: ${{ needs.setup-branch.outputs.folder-name }}/edited-movie/title.mp4
        video2-path: ${{ needs.setup-branch.outputs.folder-name }}/edited-movie/video_with_overlays.mp4
        video1-duration: ${{ fromJson(steps.read-title.outputs.title-data).duration }}
        output-path: ${{ needs.setup-branch.outputs.folder-name }}/edited-movie/basic-edited.mp4
        
    - name: Set output path and create report
      id: set-output
      run: |
        FOLDER_NAME="${{ needs.setup-branch.outputs.folder-name }}"
        echo "video-path=$FOLDER_NAME/edited-movie/basic-edited.mp4" >> $GITHUB_OUTPUT
        
        # „É¨„Éù„Éº„Éà‰ΩúÊàê
        cat > "$FOLDER_NAME/edited-movie/report.md" << EOF
        # ÂãïÁîªÁ∑®ÈõÜ„É¨„Éù„Éº„Éà
        
        ## Á∑®ÈõÜÂÜÖÂÆπ
        - **ÂÖÉÂãïÁîª**: ${{ needs.analyze-video.outputs.actual-video-path }}
        - **„Çø„Ç§„Éà„É´**: ${{ needs.analyze-video.outputs.title }}
        - **Á∑®ÈõÜÊó•ÊôÇ**: $(date)
        
        ## ËøΩÂä†„Åï„Çå„ÅüË¶ÅÁ¥†
        1. „Çø„Ç§„Éà„É´ÁîªÈù¢ÔºàÂÜíÈ†≠3ÁßíÔºâ
        2. Ë™¨Êòé„ÉÜ„Ç≠„Çπ„Éà„Ç™„Éº„Éê„Éº„É¨„Ç§Ôºà$(jq '. | length' "$FOLDER_NAME/analysis/descriptions.json")ÁÆáÊâÄÔºâ
        
        ## Âá∫Âäõ„Éï„Ç°„Ç§„É´
        - ÊúÄÁµÇÂãïÁîª: \`edited-movie/basic-edited.mp4\`
        EOF
        
    - name: Commit edited video
      run: |
        git config user.name "${{ env.GIT_USER_NAME }}"
        git config user.email "${{ env.GIT_USER_EMAIL }}"
        git add --all -- ':!.gemini/'
        if git diff --cached --quiet; then
          echo "No edited files to commit"
        else
          git commit -m "üé¨ Add edited video - Title: ${{ needs.analyze-video.outputs.title }}, Edited at: $(date)"
          git pull --rebase origin "${{ needs.setup-branch.outputs.branch-name }}"
          git push
        fi

  generate-title-image:
    runs-on: ubuntu-latest
    needs: [setup-branch, analyze-video]
    if: needs.analyze-video.outputs.analysis-completed == 'true'
    outputs:
      image-generated: ${{ steps.generate.outputs.image-generated }}
      
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        ref: ${{ needs.setup-branch.outputs.branch-name }}
        
    - name: Generate title image
      id: generate
      uses: ./modules/gemini-cli-title-image-generator
      with:
        branch-name: ${{ needs.setup-branch.outputs.branch-name }}
        folder-name: ${{ needs.setup-branch.outputs.folder-name }}
        output-path: 'title-image/background.jpg'
        commit-message: 'üñºÔ∏è Add generated title background image - Title: ${{ needs.analyze-video.outputs.title }}'
        generation-prompt: |
          üñºÔ∏è **„Çø„Ç§„Éà„É´ÁîªÂÉèÁîüÊàê„Çø„Çπ„ÇØ**
          
          „Çø„Ç§„Éà„É´„Äå${{ needs.analyze-video.outputs.title }}„Äç„Å´Âü∫„Å•„ÅÑ„ÅüËÉåÊôØÁîªÂÉè„ÇíÁîüÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
          
          1. `mkdir -p ${{ needs.setup-branch.outputs.folder-name }}/title-image`
          2. „Çø„Ç§„Éà„É´„Åã„ÇâÈ´òÂìÅË≥™„Å™ËÉåÊôØÁîªÂÉè„ÅÆ„Éó„É≠„É≥„Éó„Éà„Çí‰ΩúÊàêÔºàËã±Ë™û„Åß„ÄÅcinematic, bokeh effect, warm color paletteÁ≠â„ÇíÂê´„ÇÄÔºâ
          3. `mcp__t2i-fal-imagen4-fast__imagen4_fast_submit`„ÅßÁîüÊàêÈñãÂßã
          4. `mcp__t2i-fal-imagen4-fast__imagen4_fast_status`„ÅßÂÆå‰∫ÜÁ¢∫Ë™çÔºàÊúÄÂ§ß20ÂõûÔºâ
          5. `mcp__t2i-fal-imagen4-fast__imagen4_fast_result`„ÅßURLÂèñÂæó
          6. ÈáçË¶Å: ÂøÖ„Åö`curl -L -o "$(pwd)/${{ needs.setup-branch.outputs.folder-name }}/title-image/background.jpg" "$IMAGE_URL"`„Åß„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ
          7. generation-info.json„Å´ÁîüÊàêÊÉÖÂ†±„Çí‰øùÂ≠ò
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        T2I_FAL_IMAGEN4_FAST_URL: ${{ secrets.T2I_FAL_IMAGEN4_FAST_URL }}
        
    - name: Commit title image
      if: steps.generate.outputs.image-generated == 'true'
      run: |
        git config user.name "${{ env.GIT_USER_NAME }}"
        git config user.email "${{ env.GIT_USER_EMAIL }}"
        # .gemini/settings.json„ÇíÈô§Â§ñ„Åó„Å¶„Ç≥„Éü„ÉÉ„ÉàÔºàÊó¢„Å´Â≠òÂú®„Åô„ÇãÂ†¥Âêà„ÅÆ„Ç≥„É≥„Éï„É™„ÇØ„Éà„ÇíÈÅø„Åë„ÇãÔºâ
        git add --all -- ':!.gemini/'
        if git diff --cached --quiet; then
          echo "No title image to commit"
        else
          git commit -m "${{ steps.generate.outputs.commit-message || 'üñºÔ∏è Add generated title background image' }} - Generated at: $(date)"
          git pull --rebase origin "${{ needs.setup-branch.outputs.branch-name }}"
          git push
        fi

  generate-music:
    runs-on: ubuntu-latest
    needs: [setup-branch, analyze-video]
    if: needs.analyze-video.outputs.analysis-completed == 'true'
    outputs:
      music-generated: ${{ steps.generate.outputs.music-generated }}
      
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        ref: ${{ needs.setup-branch.outputs.branch-name }}
        
    - name: Generate music
      id: generate
      uses: ./modules/gemini-cli-music-generator
      with:
        branch-name: ${{ needs.setup-branch.outputs.branch-name }}
        folder-name: ${{ needs.setup-branch.outputs.folder-name }}
        output-path: 'music/background.wav'
        commit-message: 'üéµ Add generated background music - Title: ${{ needs.analyze-video.outputs.title }}'
        generation-prompt: |
          üéµ **Èü≥Ê•ΩÁîüÊàê„Çø„Çπ„ÇØ**
          
          „Çø„Ç§„Éà„É´„Äå${{ needs.analyze-video.outputs.title }}„Äç„Å®ÂÜÖÂÆπ„Äå${{ needs.analyze-video.outputs.descriptions-summary }}„Äç„Å´Âü∫„Å•„ÅÑ„Åü15-30Áßí„ÅÆÁü≠„ÅÑÈü≥Ê•Ω„ÇíÁîüÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
          
          1. `mkdir -p ${{ needs.setup-branch.outputs.folder-name }}/music`
          2. Ëã±Ë™û„ÅßÈü≥Ê•Ω„Éó„É≠„É≥„Éó„Éà„Çí‰ΩúÊàêÔºà‰æã: "A short 20-second ambient music"Ôºâ
          3. `mcp__t2m-google-lyria__lyria_submit`„ÅßÁîüÊàêÈñãÂßã
          4. `mcp__t2m-google-lyria__lyria_status`„ÅßÂÆå‰∫ÜÁ¢∫Ë™çÔºàÊúÄÂ§ß30Âõû„ÄÅ5ÁßíÈñìÈöîÔºâ
          5. `mcp__t2m-google-lyria__lyria_result`„ÅßURLÂèñÂæó
          6. **ÂøÖÈ†à**: `curl -L -f --retry 3 -o "$(pwd)/${{ needs.setup-branch.outputs.folder-name }}/music/background.wav" "$MUSIC_URL"`„Åß„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ
          7. „Éï„Ç°„Ç§„É´„Çµ„Ç§„Ç∫„Åå50KBÊú™Ê∫Ä„Å™„ÇâÂÜçË©¶Ë°å
          8. generation-info.json„Å´ÁîüÊàêÊÉÖÂ†±„Çí‰øùÂ≠ò
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        T2M_GOOGLE_LYRIA_URL: ${{ secrets.T2M_GOOGLE_LYRIA_URL }}
        
    - name: Commit music
      if: steps.generate.outputs.music-generated == 'true'
      run: |
        git config user.name "${{ env.GIT_USER_NAME }}"
        git config user.email "${{ env.GIT_USER_EMAIL }}"
        # .gemini/settings.json„ÇíÈô§Â§ñ„Åó„Å¶„Ç≥„Éü„ÉÉ„ÉàÔºàÊó¢„Å´Â≠òÂú®„Åô„ÇãÂ†¥Âêà„ÅÆ„Ç≥„É≥„Éï„É™„ÇØ„Éà„ÇíÈÅø„Åë„ÇãÔºâ
        git add --all -- ':!.gemini/'
        if git diff --cached --quiet; then
          echo "No music to commit"
        else
          git commit -m "üéµ Add generated background music - Title: ${{ needs.analyze-video.outputs.title }}, Generated at: $(date)"
          git pull --rebase origin "${{ needs.setup-branch.outputs.branch-name }}"
          git push
        fi

  final-verification:
    runs-on: ubuntu-latest
    needs: [setup-branch, analyze-video, edit-video, generate-title-image, generate-music]
    if: needs.analyze-video.outputs.analysis-completed == 'true'
    outputs:
      verification-passed: ${{ steps.verify-content.outputs.passed }}
      
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        ref: ${{ needs.setup-branch.outputs.branch-name }}
        
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: Install Python dependencies
      run: |
        pip install google-generativeai
        
    - name: üîç ÊúÄÁµÇÁ¢∫Ë™ç (Python Script with Gemini Vision)
      id: final-check
      env:
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      run: |
        FOLDER_NAME="${{ needs.setup-branch.outputs.folder-name }}"
        mkdir -p "$FOLDER_NAME/verification"
        
        # ÂàÜÊûê„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø
        TITLE=$(jq -r '.title' "$FOLDER_NAME/analysis/title.json")
        DESCRIPTIONS=$(cat "$FOLDER_NAME/analysis/descriptions.json")
        
        # Ê§úË®º„Éó„É≠„É≥„Éó„Éà„Çí‰ΩúÊàê
        VERIFY_PROMPT="Á∑®ÈõÜ„Åï„Çå„ÅüÂãïÁîª„ÇíÁ¢∫Ë™ç„Åó„ÄÅ‰ª•‰∏ã„ÅÆÈ†ÖÁõÆ„ÇíÊ§úË®º„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºö1. „Çø„Ç§„Éà„É´„Äå$TITLE„Äç„ÅåÂãïÁîª„ÅÆÂÜíÈ†≠„Å´Ë°®Á§∫„Åï„Çå„Å¶„ÅÑ„Çã„Åã 2. ‰ª•‰∏ã„ÅÆË™¨Êòé„ÉÜ„Ç≠„Çπ„Éà„ÅåÊåáÂÆö„Åï„Çå„Åü„Çø„Ç§„Éü„É≥„Ç∞„ÅßË°®Á§∫„Åï„Çå„Å¶„ÅÑ„Çã„ÅãÔºö$DESCRIPTIONS 3. „ÉÜ„Ç≠„Çπ„Éà„ÅÆ„Çø„Ç§„Éü„É≥„Ç∞„ÅåÈÅ©Âàá„Åã 4. ÂÖ®‰ΩìÁöÑ„Å™ÂìÅË≥™„Å®ÊîπÂñÑÁÇπ„ÄÇJSONÂΩ¢Âºè„ÅßËøî„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºö{\"status\": \"passed\" „Åæ„Åü„ÅØ \"failed\", \"title_match\": true/false, \"descriptions_accurate\": true/false, \"timing_appropriate\": true/false, \"issues\": [\"ÂïèÈ°åÁÇπ„ÅÆ„É™„Çπ„Éà\"], \"recommendations\": [\"ÊîπÂñÑÊèêÊ°à„ÅÆ„É™„Çπ„Éà\"]}"
        
        # Á∑®ÈõÜÊ∏à„ÅøÂãïÁîª„ÅåÂ≠òÂú®„Åô„Çã„ÅãÁ¢∫Ë™ç
        if [ -f "$FOLDER_NAME/edited-movie/basic-edited.mp4" ]; then
          python scripts/gemini_analyzer.py \
            "$FOLDER_NAME/edited-movie/basic-edited.mp4" \
            "$FOLDER_NAME/verification/final-check.json" \
            "$GEMINI_API_KEY" \
            --prompt "$VERIFY_PROMPT" \
            --format json
        else
          echo '{"status": "failed", "issues": ["Edited video not found"]}' > "$FOLDER_NAME/verification/final-check.json"
        fi
        
        # „Çø„Ç§„Éà„É´ÁîªÂÉè„ÅÆÊ§úË®ºÔºàÂ≠òÂú®„Åô„ÇãÂ†¥ÂêàÔºâ
        if [ -f "$FOLDER_NAME/title-image/background.jpg" ]; then
          HARMONY_PROMPT="„Åì„ÅÆ„Çø„Ç§„Éà„É´ËÉåÊôØÁîªÂÉè„Åå„ÄÅ„Çø„Ç§„Éà„É´„Äå$TITLE„Äç„Å®ÂãïÁîª„ÅÆÂÜÖÂÆπ„Å´Ë™øÂíå„Åó„Å¶„ÅÑ„Çã„ÅãË©ï‰æ°„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇJSONÂΩ¢Âºè„ÅßËøî„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºö{\"harmony_score\": 1-10„ÅÆÊï∞ÂÄ§, \"feedback\": \"Ë©ï‰æ°„Ç≥„É°„É≥„Éà\"}"
          
          python scripts/gemini_analyzer.py \
            "$FOLDER_NAME/title-image/background.jpg" \
            "$FOLDER_NAME/verification/image-harmony.json" \
            "$GEMINI_API_KEY" \
            --prompt "$HARMONY_PROMPT" \
            --format json
          
          # ÁµêÊûú„Çí„Éû„Éº„Ç∏
          if [ -f "$FOLDER_NAME/verification/image-harmony.json" ]; then
            jq -s '.[0] + {image_harmony: .[1]}' \
              "$FOLDER_NAME/verification/final-check.json" \
              "$FOLDER_NAME/verification/image-harmony.json" \
              > "$FOLDER_NAME/verification/final-check-tmp.json"
            mv "$FOLDER_NAME/verification/final-check-tmp.json" "$FOLDER_NAME/verification/final-check.json"
          fi
        fi
        
        # Ê§úË®º„É¨„Éù„Éº„Éà‰ΩúÊàê
        echo "# Content Verification Report" > "$FOLDER_NAME/verification/report.md"
        echo "" >> "$FOLDER_NAME/verification/report.md"
        STATUS=$(jq -r '.status' "$FOLDER_NAME/verification/final-check.json")
        echo "## Overall Status: ${STATUS^^}" >> "$FOLDER_NAME/verification/report.md"
        echo "" >> "$FOLDER_NAME/verification/report.md"
        echo "## Verification Completed" >> "$FOLDER_NAME/verification/report.md"
        echo "- **Date**: $(date)" >> "$FOLDER_NAME/verification/report.md"
             
    - name: Verify final check results
      id: verify-content
      run: |
        FOLDER_NAME="${{ needs.setup-branch.outputs.folder-name }}"
        
        if [ -f "$FOLDER_NAME/verification/final-check.json" ]; then
          STATUS=$(jq -r '.status' "$FOLDER_NAME/verification/final-check.json")
          if [ "$STATUS" = "passed" ]; then
            echo "‚úÖ Final verification passed"
            echo "passed=true" >> $GITHUB_OUTPUT
          else
            echo "‚ö†Ô∏è Final verification found issues"
            echo "passed=false" >> $GITHUB_OUTPUT
            
            # ÂïèÈ°åÁÇπ„ÇíË°®Á§∫
            echo "Issues found:"
            jq -r '.issues[]' "$FOLDER_NAME/verification/final-check.json" 2>/dev/null || true
          fi
        else
          echo "‚ö†Ô∏è Verification file not found"
          echo "passed=false" >> $GITHUB_OUTPUT
        fi
        
    - name: Commit verification results
      run: |
        git config user.name "${{ env.GIT_USER_NAME }}"
        git config user.email "${{ env.GIT_USER_EMAIL }}"
        git add --all -- ':!.gemini/'
        if git diff --cached --quiet; then
          echo "No verification files to commit"
        else
          git commit -m "üîç Add final verification results - Status: ${{ steps.verify-content.outputs.passed == 'true' && 'Passed' || 'Issues found' }}, Verified at: $(date)"
          git pull --rebase origin "${{ needs.setup-branch.outputs.branch-name }}"
          git push
        fi

  integrate-final-video:
    runs-on: ubuntu-latest
    needs: [setup-branch, analyze-video, edit-video, generate-title-image, generate-music, final-verification]
    if: needs.analyze-video.outputs.analysis-completed == 'true' && (needs.generate-title-image.outputs.image-generated == 'true' || needs.generate-music.outputs.music-generated == 'true')
    outputs:
      final-video-path: ${{ steps.finalize-enhanced.outputs.final-path }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        ref: ${{ needs.setup-branch.outputs.branch-name }}
        
    - name: Install FFmpeg and Fonts
      run: |
        sudo apt-get update
        sudo apt-get install -y ffmpeg bc
        # Install Japanese fonts for title rendering
        sudo apt-get install -y fonts-noto-cjk fonts-ipafont-gothic fonts-ipafont-mincho
        ffmpeg -version
        fc-list | grep -i noto || true
        
    - name: Read title data for final video
      id: read-title-final
      run: |
        FOLDER_NAME="${{ needs.setup-branch.outputs.folder-name }}"
        TITLE_DATA=$(cat "$FOLDER_NAME/analysis/title.json")
        echo "title-data<<EOF" >> $GITHUB_OUTPUT
        echo "$TITLE_DATA" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
    - name: Get video resolution
      id: video-res-final
      run: |
        RESOLUTION=$(ffprobe -v error -select_streams v:0 -show_entries stream=width,height -of csv=s=x:p=0 "${{ needs.analyze-video.outputs.actual-video-path }}")
        echo "video_resolution=$RESOLUTION" >> $GITHUB_OUTPUT
        
    - name: Generate enhanced title with background
      id: generate-enhanced-title
      if: needs.generate-title-image.outputs.image-generated == 'true'
      uses: ./modules/ffmpeg-title-generator
      with:
        title: ${{ fromJson(steps.read-title-final.outputs.title-data).title }}
        duration: ${{ fromJson(steps.read-title-final.outputs.title-data).duration }}
        resolution: ${{ steps.video-res-final.outputs.video_resolution }}
        fontsize: ${{ fromJson(steps.read-title-final.outputs.title-data).style.fontsize }}
        color: ${{ fromJson(steps.read-title-final.outputs.title-data).style.color }}
        bgcolor: ${{ fromJson(steps.read-title-final.outputs.title-data).style.bgcolor }}
        fontfile: ${{ env.FONT_FILE }}
        background-image: ${{ needs.setup-branch.outputs.folder-name }}/title-image/background.jpg
        output-path: ${{ needs.setup-branch.outputs.folder-name }}/edited-movie/title_with_bg.mp4
        
    - name: Combine enhanced title with video
      id: combine-enhanced
      if: needs.generate-title-image.outputs.image-generated == 'true'
      uses: ./modules/ffmpeg-video-concat
      with:
        video1-path: ${{ needs.setup-branch.outputs.folder-name }}/edited-movie/title_with_bg.mp4
        video2-path: ${{ needs.setup-branch.outputs.folder-name }}/edited-movie/video_with_overlays.mp4
        video1-duration: ${{ fromJson(steps.read-title-final.outputs.title-data).duration }}
        output-path: ${{ needs.setup-branch.outputs.folder-name }}/edited-movie/video_enhanced.mp4
        
    - name: Generate enhanced video with background and music
      id: finalize-enhanced
      run: |
        FOLDER_NAME="${{ needs.setup-branch.outputs.folder-name }}"
        
        # ÂÖÉ„ÅÆ„Éì„Éá„Ç™„Éï„Ç°„Ç§„É´Âêç„ÇíÂèñÂæóÔºà„Éë„Çπ„Å®extension„ÇíÈô§ÂéªÔºâ
        ORIGINAL_VIDEO="${{ needs.analyze-video.outputs.actual-video-path }}"
        VIDEO_BASENAME=$(basename "$ORIGINAL_VIDEO" | sed 's/\.[^.]*$//')
        
        # ‰ΩøÁî®„Åô„ÇãÂãïÁîª„ÇíÊ±∫ÂÆöÔºàËÉåÊôØÁîªÂÉè„Åå„ÅÇ„Çå„Å∞Âº∑ÂåñÁâà„ÄÅ„Å™„Åë„Çå„Å∞ÈÄöÂ∏∏ÁâàÔºâ
        if [ "${{ needs.generate-title-image.outputs.image-generated }}" = "true" ]; then
          echo "üñºÔ∏è Using enhanced title with background image"
            
          # „Ç™„É™„Ç∏„Éä„É´„ÅÆÂãïÁîªÔºà„Çø„Ç§„Éà„É´„Å™„ÅóÔºâ„Åã„ÇâÂãïÁîªÈÉ®ÂàÜ„ÇíÂèñÂæó
          # video_with_overlays.mp4„Çí‰ΩøÁî®Ôºà„Åì„Çå„ÅØ„Çø„Ç§„Éà„É´„Å™„Åó„ÅÆÂãïÁîªÔºâ
          
          VIDEO_FOR_MUSIC="$FOLDER_NAME/edited-movie/video_enhanced.mp4"
        else
          echo "üìπ Using standard video"
          VIDEO_FOR_MUSIC="$FOLDER_NAME/edited-movie/basic-edited.mp4"
        fi
        
        # Èü≥Ê•Ω„Éï„Ç°„Ç§„É´„ÇíÊé¢„Åô
        if [ "${{ needs.generate-music.outputs.music-generated }}" = "true" ]; then
          if [ -f "$FOLDER_NAME/music/background.mp3" ]; then
            MUSIC_FILE="$FOLDER_NAME/music/background.mp3"
          elif [ -f "$FOLDER_NAME/music/background.wav" ]; then
            MUSIC_FILE="$FOLDER_NAME/music/background.wav"
          else
            echo "‚ö†Ô∏è Music file not found!"
            exit 1
          fi
          echo "music-file=$MUSIC_FILE" >> $GITHUB_OUTPUT
        fi
        
        # ÊúÄÁµÇÂá∫Âäõ„Éï„Ç°„Ç§„É´Âêç„ÇíË®≠ÂÆö
        FINAL_OUTPUT="$FOLDER_NAME/edited-movie/${VIDEO_BASENAME}-final-edited.mp4"
        echo "final-path=$FINAL_OUTPUT" >> $GITHUB_OUTPUT
        echo "video-for-music=$VIDEO_FOR_MUSIC" >> $GITHUB_OUTPUT
        
    - name: Add background music
      id: add-music
      if: needs.generate-music.outputs.music-generated == 'true'
      uses: ./modules/ffmpeg-add-music
      with:
        video-path: ${{ steps.finalize-enhanced.outputs.video-for-music }}
        music-path: ${{ steps.finalize-enhanced.outputs.music-file }}
        volume: '0.3'
        output-path: ${{ steps.finalize-enhanced.outputs.final-path }}
        
    - name: Copy video without music
      if: needs.generate-music.outputs.music-generated != 'true'
      run: |
        cp "${{ steps.finalize-enhanced.outputs.video-for-music }}" "${{ steps.finalize-enhanced.outputs.final-path }}"
        echo "‚úÖ Final video copied without music"
        
    - name: Commit enhanced video
      run: |
        git config user.name "${{ env.GIT_USER_NAME }}"
        git config user.email "${{ env.GIT_USER_EMAIL }}"
        git add --all -- ':!.gemini/'
        if git diff --cached --quiet; then
          echo "No enhanced video to commit"
        else
          git commit -m "üé¨ Add enhanced video with title background - Title: ${{ needs.analyze-video.outputs.title }}, Enhanced at: $(date)"
          git pull --rebase origin "${{ needs.setup-branch.outputs.branch-name }}"
          git push
        fi

  create-pull-request:
    runs-on: ubuntu-latest
    needs: [setup-branch, analyze-video, edit-video, generate-title-image, generate-music, final-verification, integrate-final-video]
    if: always()
    
    steps:
    - uses: actions/checkout@v4
      with:
        ref: ${{ needs.setup-branch.outputs.branch-name }}
        token: ${{ secrets.PAT_TOKEN || github.token }}
        
    - name: Create Pull Request
      continue-on-error: true
      run: |
        gh pr create \
          --title "üé¨ Video Edit: ${{ needs.analyze-video.outputs.title }}" \
          --body "$(cat <<'EOF'
        ## Summary
        Analyzed and edited video with AI-generated title and explanatory overlays.
        
        ## Input
        - **Video**: ${{ needs.analyze-video.outputs.actual-video-path }}
        - **Custom Title**: ${{ github.event.inputs.edit_title }}
        
        ## Processing Pipeline
        1. üìä **Analysis**: Gemini Vision analyzed video content
        2. üéØ **Title**: Generated/used title "${{ needs.analyze-video.outputs.title }}"
        3. üìù **Overlays**: Added explanatory text at key moments
        4. üé¨ **Edit**: Combined with FFmpeg (fade effects included)
        
        ## Generated Files
        - üìä Analysis: `analysis/` directory
        - üñºÔ∏è Title Image: `title-image/` directory
        - üéµ Music: `music/` directory
        - üé¨ Edited Videos: 
          - `edited-movie/basic-edited.mp4` (standard)
          - `edited-movie/[original-filename]-final-edited.mp4` (with AI background and music)
        - üîç Verification: `verification/` directory
        - üìù Reports: `edited-movie/report.md`, `README.md`
        
        ## Workflow Status
        - ‚úÖ Video Analysis: Completed
        - ‚úÖ Title Generation: Completed
        - ‚úÖ Video Editing: Completed with FFmpeg
        - ${{ needs.generate-title-image.outputs.image-generated == 'true' && '‚úÖ' || '‚ö†Ô∏è' }} Title Image Generation: ${{ needs.generate-title-image.outputs.image-generated == 'true' && 'Completed' || 'Skipped/Failed' }}
        - ${{ needs.generate-music.outputs.music-generated == 'true' && '‚úÖ' || '‚ö†Ô∏è' }} Music Generation: ${{ needs.generate-music.outputs.music-generated == 'true' && 'Completed' || 'Skipped/Failed' }}
        - ${{ needs.final-verification.outputs.verification-passed == 'true' && '‚úÖ' || '‚ö†Ô∏è' }} Final Verification: ${{ needs.final-verification.outputs.verification-passed == 'true' && 'Passed' || 'Issues Found' }}
        - ${{ (needs.generate-title-image.outputs.image-generated == 'true' || needs.generate-music.outputs.music-generated == 'true') && '‚úÖ' || '‚ö†Ô∏è' }} Enhanced Video: ${{ (needs.generate-title-image.outputs.image-generated == 'true' || needs.generate-music.outputs.music-generated == 'true') && 'Generated' || 'Skipped' }}
        EOF
        )" \
          --head "${{ needs.setup-branch.outputs.branch-name }}" \
          --base main
      env:
        GH_TOKEN: ${{ secrets.PAT_TOKEN }}
        
    - name: Create PR Summary (No PAT)
      if: failure()
      run: |
        echo "‚ö†Ô∏è Pull Request creation skipped - PAT_TOKEN not configured"
        echo "To enable automatic PR creation, please add a Personal Access Token with 'repo' and 'pull_request' permissions as PAT_TOKEN in repository secrets."
        echo ""
        echo "Branch created: ${{ needs.setup-branch.outputs.branch-name }}"
        echo "You can manually create a PR from this branch."
