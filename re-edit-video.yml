name: Re-Edit Existing Video

on:
  workflow_dispatch:
    inputs:
      text_position:
        description: 'ãƒ†ã‚­ã‚¹ãƒˆã®è¡¨ç¤ºä½ç½®'
        required: false
        type: choice
        default: 'default'
        options:
          - 'default'
          - 'å·¦ä¸Š'
          - 'ä¸Š'
          - 'å³ä¸Š'
          - 'å·¦ä¸‹'
          - 'ä¸‹'
          - 'å³ä¸‹'
      add_title_image:
        description: 'ã‚¿ã‚¤ãƒˆãƒ«ç”»åƒã‚’è¿½åŠ ã™ã‚‹'
        required: false
        type: boolean
        default: false
      add_background_music:
        description: 'èƒŒæ™¯éŸ³æ¥½ã‚’è¿½åŠ ã™ã‚‹'
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  pull-requests: write

env:
  GIT_USER_NAME: "github-actions[bot]"
  GIT_USER_EMAIL: "github-actions[bot]@users.noreply.github.com"
  FONT_FILE: "/usr/share/fonts/opentype/noto/NotoSansCJK-Regular.ttc"

jobs:
  find-folder:
    runs-on: ubuntu-latest
    outputs:
      folder-name: ${{ steps.find.outputs.folder-name }}
      folder-found: ${{ steps.find.outputs.folder-found }}
      video-path: ${{ steps.find.outputs.video-path }}
      target-branch: ${{ steps.find.outputs.target-branch }}
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        ref: ${{ needs.find-folder.outputs.target-branch || github.ref_name }}
        fetch-depth: 0  # ã™ã¹ã¦ã®ãƒ–ãƒ©ãƒ³ãƒæƒ…å ±ã‚’å–å¾—
        
    - name: Find latest movie-edit folder
      id: find
      run: |
        echo "ğŸ” Finding movie-edit folders in branch: ${{ github.ref_name }}"
        
        # Find all movie-edit-* folders and sort by timestamp
        FOLDERS=$(ls -d movie-edit-* 2>/dev/null | sort -r)
        
        if [ -z "$FOLDERS" ]; then
          echo "âŒ No movie-edit folders found in current branch: ${{ github.ref_name }}"
          
          # mainãƒ–ãƒ©ãƒ³ãƒã®å ´åˆã®ã¿ã€ä»–ã®ãƒ–ãƒ©ãƒ³ãƒã‚’æ¢ã™
          if [ "${{ github.ref_name }}" = "main" ]; then
            echo "ğŸ” Main branch selected but no folders found. Searching for latest video-edit-* branch..."
            
            # ã™ã¹ã¦ã®ãƒ–ãƒ©ãƒ³ãƒã‚’å–å¾—
            git fetch --all
            
            # video-edit-*ãƒ–ãƒ©ãƒ³ãƒã‚’æ™‚é–“é †ã«ã‚½ãƒ¼ãƒˆï¼ˆæœ€æ–°ãŒå…ˆé ­ï¼‰
            LATEST_VIDEO_BRANCH=$(git branch -r --sort=-committerdate | grep 'origin/video-edit-' | head -1 | sed 's/.*origin\///')
            
            if [ -z "$LATEST_VIDEO_BRANCH" ]; then
              echo "âŒ No video-edit-* branches found"
              echo "folder-found=false" >> $GITHUB_OUTPUT
              exit 0
            fi
            
            echo "âœ… Found latest video-edit branch: $LATEST_VIDEO_BRANCH"
            
            # ãã®ãƒ–ãƒ©ãƒ³ãƒã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
            git checkout "$LATEST_VIDEO_BRANCH"
            
            # å†åº¦ãƒ•ã‚©ãƒ«ãƒ€ã‚’æ¢ã™
            FOLDERS=$(ls -d movie-edit-* 2>/dev/null | sort -r)
            
            if [ -z "$FOLDERS" ]; then
              echo "âŒ No movie-edit folders found even in $LATEST_VIDEO_BRANCH"
              echo "folder-found=false" >> $GITHUB_OUTPUT
              exit 0
            fi
            
            # ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒ–ãƒ©ãƒ³ãƒã‚’è¨­å®š
            echo "target-branch=$LATEST_VIDEO_BRANCH" >> $GITHUB_OUTPUT
          else
            # mainä»¥å¤–ã®ãƒ–ãƒ©ãƒ³ãƒã§ãƒ•ã‚©ãƒ«ãƒ€ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯çµ‚äº†
            echo "âŒ No movie-edit folders found in branch ${{ github.ref_name }} (not searching other branches)"
            echo "folder-found=false" >> $GITHUB_OUTPUT
            exit 0
          fi
        else
          # ç¾åœ¨ã®ãƒ–ãƒ©ãƒ³ãƒã‚’ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒ–ãƒ©ãƒ³ãƒã¨ã—ã¦è¨­å®š
          echo "target-branch=${{ github.ref_name }}" >> $GITHUB_OUTPUT
        fi
        
        echo "ğŸ“‹ Found folders:"
        echo "$FOLDERS"
        
        # Get the most recent folder (already sorted in reverse order by timestamp)
        LATEST_FOLDER=$(echo "$FOLDERS" | head -1)
        echo "âœ… Using most recent folder: $LATEST_FOLDER"
        
        # Extract timestamp from folder name for display
        TIMESTAMP=$(echo "$LATEST_FOLDER" | grep -oP '\d{8}-\d{6}')
        if [ -n "$TIMESTAMP" ]; then
          # Convert to Japanese time format for display
          YEAR=${TIMESTAMP:0:4}
          MONTH=${TIMESTAMP:4:2}
          DAY=${TIMESTAMP:6:2}
          HOUR=${TIMESTAMP:9:2}
          MIN=${TIMESTAMP:11:2}
          SEC=${TIMESTAMP:13:2}
          echo "ğŸ“… Folder timestamp: ${YEAR}å¹´${MONTH}æœˆ${DAY}æ—¥ ${HOUR}:${MIN}:${SEC} (JST)"
        fi
        
        # Find the original video path from report
        echo "ğŸ” Looking for report files in: $LATEST_FOLDER/work-in-progress/"
        
        # Check for both report.md and re-edit-report.md
        REPORT_FILE=""
        if [ -f "$LATEST_FOLDER/work-in-progress/report.md" ]; then
          REPORT_FILE="$LATEST_FOLDER/work-in-progress/report.md"
          echo "âœ… Found report.md"
        elif [ -f "$LATEST_FOLDER/work-in-progress/re-edit-report.md" ]; then
          REPORT_FILE="$LATEST_FOLDER/work-in-progress/re-edit-report.md"
          echo "âœ… Found re-edit-report.md"
        fi
        
        if [ -n "$REPORT_FILE" ]; then
          cat "$REPORT_FILE"
          # Extract video path from report
          VIDEO_PATH=$(grep -oP '\*\*å…ƒå‹•ç”»\*\*: \K[^\s]+' "$REPORT_FILE" | head -1 || echo "")
          echo "ğŸ“„ Extracted video path: $VIDEO_PATH"
        else
          echo "âŒ No report file found"
          # Check what files exist in the folder
          echo "ğŸ“ Contents of $LATEST_FOLDER:"
          ls -la "$LATEST_FOLDER/" || echo "Folder not accessible"
          if [ -d "$LATEST_FOLDER/work-in-progress" ]; then
            echo "ğŸ“ Contents of work-in-progress:"
            ls -la "$LATEST_FOLDER/work-in-progress/" || echo "work-in-progress not accessible"
          fi
          if [ -d "$LATEST_FOLDER/analysis" ]; then
            echo "ğŸ“ Contents of analysis:"
            ls -la "$LATEST_FOLDER/analysis/" || echo "analysis not accessible"
          fi
        fi
        
        # Fallback: check git commit messages
        if [ -z "$VIDEO_PATH" ]; then
          VIDEO_PATH=$(git log --oneline -n 50 | grep -oP 'Video: \K[^,]+' | head -1 || echo "")
          if [ -n "$VIDEO_PATH" ]; then
            echo "ğŸ“ Found video path in git log: $VIDEO_PATH"
          fi
        fi
        
        # Fallback: find in videos directory
        if [ -z "$VIDEO_PATH" ] || [ ! -f "$VIDEO_PATH" ]; then
          echo "âš ï¸ Could not find original video path, searching in videos directory..."
          VIDEO_PATH=$(find videos -name "*.mp4" -type f | head -1)
          if [ -z "$VIDEO_PATH" ]; then
            echo "âŒ No video file found in videos directory"
            exit 1
          fi
        fi
        
        echo "ğŸ“¹ Video path: $VIDEO_PATH"
        
        echo "folder-name=$LATEST_FOLDER" >> $GITHUB_OUTPUT
        echo "folder-found=true" >> $GITHUB_OUTPUT
        echo "video-path=$VIDEO_PATH" >> $GITHUB_OUTPUT

  edit-video:
    runs-on: ubuntu-latest
    needs: find-folder
    if: needs.find-folder.outputs.folder-found == 'true'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        ref: ${{ needs.find-folder.outputs.target-branch || github.ref_name }}
        
    - name: Clean existing directories
      run: |
        FOLDER_NAME="${{ needs.find-folder.outputs.folder-name }}"
        echo "ğŸ§¹ Cleaning existing directories in $FOLDER_NAME..."
        
        # Clean work-in-progress directory
        if [ -d "$FOLDER_NAME/work-in-progress" ]; then
          echo "Removing work-in-progress directory..."
          rm -rf "$FOLDER_NAME/work-in-progress"
        fi
        
        # Clean final-output directory
        if [ -d "$FOLDER_NAME/final-output" ]; then
          echo "Removing final-output directory..."
          rm -rf "$FOLDER_NAME/final-output"
        fi
        
        # Recreate directories
        mkdir -p "$FOLDER_NAME/work-in-progress"
        mkdir -p "$FOLDER_NAME/final-output"
        echo "âœ… Directories cleaned and recreated"
        
    - name: Install FFmpeg and Fonts
      run: |
        sudo apt-get update
        sudo apt-get install -y ffmpeg
        sudo apt-get install -y fonts-noto-cjk fonts-ipafont-gothic fonts-ipafont-mincho
        ffmpeg -version
        
    - name: Get video resolution
      id: video-res
      run: |
        VIDEO_PATH="${{ needs.find-folder.outputs.video-path }}"
        if [ -f "$VIDEO_PATH" ]; then
          RESOLUTION=$(ffprobe -v error -select_streams v:0 -show_entries stream=width,height -of csv=s=x:p=0 "$VIDEO_PATH")
          echo "video_resolution=$RESOLUTION" >> $GITHUB_OUTPUT
          echo "Original video resolution: $RESOLUTION"
        else
          echo "âš ï¸ Video file not found, using default resolution"
          echo "video_resolution=1920x1080" >> $GITHUB_OUTPUT
        fi


    - name: Update text position if specified
      if: github.event.inputs.text_position != 'default' && github.event.inputs.text_position != ''
      run: |
        FOLDER_NAME="${{ needs.find-folder.outputs.folder-name }}"
        TEXT_POSITION="${{ github.event.inputs.text_position }}"
        
        # ãƒ†ã‚­ã‚¹ãƒˆä½ç½®ã®æ±ºå®š
        case "$TEXT_POSITION" in
          "å·¦ä¸Š") POSITION="top-left" ;;
          "ä¸Š") POSITION="top-center" ;;
          "å³ä¸Š") POSITION="top-right" ;;
          "å·¦ä¸‹") POSITION="bottom-left" ;;
          "ä¸‹") POSITION="bottom-center" ;;
          "å³ä¸‹") POSITION="bottom-right" ;;
          *) POSITION="$TEXT_POSITION" ;;
        esac
        
        echo "ğŸ“ Updating text position to: $POSITION"
        
        # æ—¢å­˜ã®descriptions.jsonã‚’èª­ã¿è¾¼ã‚“ã§ä½ç½®ã‚’æ›´æ–°
        if [ -f "$FOLDER_NAME/analysis/descriptions.json" ]; then
          jq --arg pos "$POSITION" 'map(.position = $pos)' "$FOLDER_NAME/analysis/descriptions.json" > "$FOLDER_NAME/analysis/descriptions_temp.json"
          mv "$FOLDER_NAME/analysis/descriptions_temp.json" "$FOLDER_NAME/analysis/descriptions.json"
          echo "âœ… Updated all text positions to: $POSITION"
        fi


    - name: Read title data
      id: read-title
      run: |
        FOLDER_NAME="${{ needs.find-folder.outputs.folder-name }}"
        TITLE_DATA=$(cat "$FOLDER_NAME/analysis/title.json")
        echo "title-data<<EOF" >> $GITHUB_OUTPUT
        echo "$TITLE_DATA" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: Generate title video from existing image
      if: github.event.inputs.add_title_image == 'true'
      uses: ./modules/ffmpeg-title-generator
      with:
        title: ${{ fromJson(steps.read-title.outputs.title-data).title }}
        duration: ${{ fromJson(steps.read-title.outputs.title-data).duration }}
        resolution: ${{ steps.video-res.outputs.video_resolution }}
        fontsize: ${{ fromJson(steps.read-title.outputs.title-data).style.fontsize }}
        color: ${{ fromJson(steps.read-title.outputs.title-data).style.color }}
        bgcolor: ${{ fromJson(steps.read-title.outputs.title-data).style.bgcolor }}
        fontfile: ${{ env.FONT_FILE }}
        background-image: ${{ needs.find-folder.outputs.folder-name }}/title-image/background.jpg
        output-path: ${{ needs.find-folder.outputs.folder-name }}/work-in-progress/title.mp4
        
    - name: Apply text overlays
      uses: ./modules/ffmpeg-text-overlay
      with:
        video-path: ${{ needs.find-folder.outputs.video-path }}
        descriptions-json: ${{ needs.find-folder.outputs.folder-name }}/analysis/descriptions.json
        fontfile: ${{ env.FONT_FILE }}
        output-path: ${{ needs.find-folder.outputs.folder-name }}/work-in-progress/video_with_overlays.mp4
        
    - name: Process video based on options
      run: |
        FOLDER_NAME="${{ needs.find-folder.outputs.folder-name }}"
        
        # ã‚¿ã‚¤ãƒˆãƒ«ç”»åƒã‚‚éŸ³æ¥½ã‚‚è¿½åŠ ã—ãªã„å ´åˆã®ã¿ã€final-outputã«ç§»å‹•
        if [ "${{ github.event.inputs.add_title_image }}" != "true" ] && [ "${{ github.event.inputs.add_background_music }}" != "true" ]; then
          echo "ğŸ“ No title or music requested - moving to final output"
          cp "$FOLDER_NAME/work-in-progress/video_with_overlays.mp4" "$FOLDER_NAME/final-output/final-edited.mp4"
          echo "âœ… Moved video_with_overlays.mp4 to final-output/final-edited.mp4"
        else
          echo "ğŸ¬ Title or music requested - keeping in work-in-progress for further processing"
          # video_with_overlays.mp4ã¯ãã®ã¾ã¾work-in-progressã«æ®‹ã™
        fi
        
    - name: Create report
      run: |
        FOLDER_NAME="${{ needs.find-folder.outputs.folder-name }}"
        TITLE=$(jq -r '.title' "$FOLDER_NAME/analysis/title.json")
        
        cat > "$FOLDER_NAME/work-in-progress/re-edit-report.md" << EOF
        # å‹•ç”»å†ç·¨é›†ãƒ¬ãƒãƒ¼ãƒˆ
        
        ## ç·¨é›†å†…å®¹
        - **å…ƒå‹•ç”»**: ${{ needs.find-folder.outputs.video-path }}
        - **ã‚¿ã‚¤ãƒˆãƒ«**: $TITLE
        - **å†ç·¨é›†æ—¥æ™‚**: $(TZ=Asia/Tokyo date)
        - **ä½¿ç”¨ãƒ–ãƒ©ãƒ³ãƒ**: ${{ needs.find-folder.outputs.target-branch || github.ref_name }}
        
        ## å¤‰æ›´å†…å®¹
        - ãƒ†ã‚­ã‚¹ãƒˆä½ç½®: ${{ github.event.inputs.text_position }}
        - ã‚¿ã‚¤ãƒˆãƒ«ç”»åƒè¿½åŠ : ${{ github.event.inputs.add_title_image && 'ã‚ã‚Š' || 'ãªã—' }}
        - èƒŒæ™¯éŸ³æ¥½è¿½åŠ : ${{ github.event.inputs.add_background_music && 'ã‚ã‚Š' || 'ãªã—' }}
        
        ## å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«
        - æœ€çµ‚å‹•ç”»: \`final-output/final-edited.mp4\`
        EOF
        
    - name: Commit re-edited video
      run: |
        git config user.name "${{ env.GIT_USER_NAME }}"
        git config user.email "${{ env.GIT_USER_EMAIL }}"
        git add --all
        git commit -m "ğŸ”„ Re-edit video - Branch: ${{ needs.find-folder.outputs.target-branch || github.ref_name }}, Re-edited at: $(TZ=Asia/Tokyo date)"
        git push

  integrate-final-video:
    runs-on: ubuntu-latest
    needs: [find-folder, edit-video]
    if: |
      always() && 
      needs.find-folder.outputs.folder-found == 'true' &&
      needs.edit-video.result == 'success' &&
      (github.event.inputs.add_title_image == 'true' || github.event.inputs.add_background_music == 'true')
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        ref: ${{ needs.find-folder.outputs.target-branch || github.ref_name }}
        
    - name: Install FFmpeg and Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y ffmpeg jq fonts-noto-cjk
        
    - name: Check existing assets and prepare integration
      id: check-assets
      run: |
        FOLDER_NAME="${{ needs.find-folder.outputs.folder-name }}"
        
        # ã‚¢ã‚»ãƒƒãƒˆã®å­˜åœ¨ã‚’ç¢ºèª
        HAS_TITLE_IMAGE="false"
        HAS_MUSIC="false"
        
        if [ -f "$FOLDER_NAME/title-image/background.jpg" ]; then
          echo "âœ… Found title background image"
          HAS_TITLE_IMAGE="true"
        else
          echo "âŒ No title background image found"
        fi
        
        if [ -f "$FOLDER_NAME/music/background.wav" ]; then
          echo "âœ… Found background music"
          HAS_MUSIC="true"
        else
          echo "âŒ No background music found"
        fi
        
        # Check if title video was already created in edit-video job
        if [ "${{ github.event.inputs.add_title_image }}" = "true" ] && [ "$HAS_TITLE_IMAGE" = "true" ]; then
          if [ -f "$FOLDER_NAME/work-in-progress/title.mp4" ]; then
            echo "âœ… Title video already exists from edit-video job"
          else
            echo "âš ï¸ Title video not found, but title image exists"
          fi
        fi
        
        # ã‚¿ã‚¤ãƒˆãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        if [ -f "$FOLDER_NAME/analysis/title.json" ]; then
          TITLE_DATA=$(cat "$FOLDER_NAME/analysis/title.json")
          echo "title-data<<EOF" >> $GITHUB_OUTPUT
          echo "$TITLE_DATA" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        fi
        
        # ãƒ“ãƒ‡ã‚ªè§£åƒåº¦ã‚’å–å¾—
        VIDEO_PATH="${{ needs.find-folder.outputs.video-path }}"
        if [ -f "$VIDEO_PATH" ]; then
          RESOLUTION=$(ffprobe -v error -select_streams v:0 -show_entries stream=width,height -of csv=s=x:p=0 "$VIDEO_PATH")
        else
          RESOLUTION="1920x1080"
        fi
        
        echo "has-title-image=$HAS_TITLE_IMAGE" >> $GITHUB_OUTPUT
        echo "has-music=$HAS_MUSIC" >> $GITHUB_OUTPUT
        echo "video-resolution=$RESOLUTION" >> $GITHUB_OUTPUT
        
    - name: Add title if requested
      if: github.event.inputs.add_title_image == 'true' && steps.check-assets.outputs.has-title-image == 'true'
      uses: ./modules/ffmpeg-video-concat
      with:
        video1-path: ${{ needs.find-folder.outputs.folder-name }}/work-in-progress/title.mp4
        video2-path: ${{ needs.find-folder.outputs.folder-name }}/work-in-progress/video_with_overlays.mp4
        video1-duration: ${{ fromJson(steps.check-assets.outputs.title-data).duration }}
        output-path: ${{ needs.find-folder.outputs.folder-name }}/work-in-progress/video_with_title.mp4
        
    - name: Determine video path for music
      id: video-path
      run: |
        FOLDER_NAME="${{ needs.find-folder.outputs.folder-name }}"
        
        # ã‚¿ã‚¤ãƒˆãƒ«ãŒè¿½åŠ ã•ã‚Œã¦ã„ã‚Œã°ãã‚Œã‚’ä½¿ç”¨ã€ãªã‘ã‚Œã°ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã®ã¿ã®å‹•ç”»ã‚’ä½¿ç”¨
        if [ -f "$FOLDER_NAME/work-in-progress/video_with_title.mp4" ]; then
          echo "video-path=$FOLDER_NAME/work-in-progress/video_with_title.mp4" >> $GITHUB_OUTPUT
        else
          echo "video-path=$FOLDER_NAME/work-in-progress/video_with_overlays.mp4" >> $GITHUB_OUTPUT
        fi
        
    - name: Add music if requested
      if: github.event.inputs.add_background_music == 'true' && steps.check-assets.outputs.has-music == 'true'
      uses: ./modules/ffmpeg-add-music
      with:
        video-path: ${{ steps.video-path.outputs.video-path }}
        music-path: ${{ needs.find-folder.outputs.folder-name }}/music/background.wav
        volume: '0.3'
        output-path: ${{ needs.find-folder.outputs.folder-name }}/work-in-progress/final-edited.mp4
        
        
    - name: Move final video to output directory
      run: |
        FOLDER_NAME="${{ needs.find-folder.outputs.folder-name }}"
        mkdir -p "$FOLDER_NAME/final-output"
        
        # æœ€çµ‚çš„ãªãƒ“ãƒ‡ã‚ªãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç‰¹å®šã—ã¦ç§»å‹•
        if [ -f "$FOLDER_NAME/work-in-progress/final-edited.mp4" ]; then
          # éŸ³æ¥½ãŒè¿½åŠ ã•ã‚ŒãŸå ´åˆ
          mv "$FOLDER_NAME/work-in-progress/final-edited.mp4" "$FOLDER_NAME/final-output/"
          echo "âœ… Final video with music moved to final-output directory"
        elif [ -f "$FOLDER_NAME/work-in-progress/video_with_title.mp4" ]; then
          # ã‚¿ã‚¤ãƒˆãƒ«ã®ã¿è¿½åŠ ã•ã‚ŒãŸå ´åˆ
          mv "$FOLDER_NAME/work-in-progress/video_with_title.mp4" "$FOLDER_NAME/final-output/final-edited.mp4"
          echo "âœ… Video with title moved to final-output directory"
        elif [ -f "$FOLDER_NAME/work-in-progress/video_with_overlays.mp4" ]; then
          # ä½•ã‚‚è¿½åŠ ã•ã‚Œã¦ã„ãªã„å ´åˆï¼ˆã“ã‚Œã¯é€šå¸¸edit-videoã‚¸ãƒ§ãƒ–ã§å‡¦ç†ã•ã‚Œã‚‹ï¼‰
          echo "âš ï¸ No enhancements were added, video should have been moved in edit-video job"
        else
          echo "âŒ No video file found!"
          exit 1
        fi
        
    - name: Final commit
      run: |
        git config user.name "${{ env.GIT_USER_NAME }}"
        git config user.email "${{ env.GIT_USER_EMAIL }}"
        git add --all -- ':!.gemini/'
        if git diff --cached --quiet; then
          echo "No final changes to commit"
        else
          git commit -m "âœ¨ Complete re-edit with enhanced assets - Re-edited at: $(TZ=Asia/Tokyo date)"
          git pull --rebase origin "${{ github.ref_name }}"
          git push
        fi

  create-pull-request:
    runs-on: ubuntu-latest
    needs: [find-folder, edit-video, integrate-final-video]
    if: needs.find-folder.outputs.folder-found == 'true' && always()
    
    steps:
    - uses: actions/checkout@v4
      with:
        ref: ${{ github.ref_name }}
        token: ${{ secrets.PAT_TOKEN || github.token }}
        
    - name: Create Pull Request
      continue-on-error: true
      run: |
        gh pr create \
          --title "ğŸ”„ Re-Edit: ${{ needs.find-folder.outputs.target-branch || github.ref_name }}" \
          --body "$(cat <<'EOF'
        ## Summary
        Re-edited existing video from branch: ${{ needs.find-folder.outputs.target-branch || github.ref_name }}
        
        ## Changes
        - Text Position: ${{ github.event.inputs.text_position }}
        - Add Title Image: ${{ github.event.inputs.add_title_image }}
        - Add Background Music: ${{ github.event.inputs.add_background_music }}
        
        ## Files
        - ğŸ¬ Re-edited Video: `${{ needs.find-folder.outputs.folder-name }}/final-output/final-edited.mp4`
        - ğŸ“ Report: `${{ needs.find-folder.outputs.folder-name }}/work-in-progress/re-edit-report.md`
        
        ## Original Info
        - Original Video: ${{ needs.find-folder.outputs.video-path }}
        - Folder: ${{ needs.find-folder.outputs.folder-name }}
        - Re-edited at: $(TZ=Asia/Tokyo date)
        EOF
        )" \
          --head "${{ needs.find-folder.outputs.target-branch || github.ref_name }}" \
          --base main
      env:
        GH_TOKEN: ${{ secrets.PAT_TOKEN }}