name: 'FFmpeg Video Concatenation'
description: 'Concatenate videos with proper audio sync using FFmpeg'
author: 'KamuiCode'

inputs:
  video1-path:
    description: 'æœ€åˆã®å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ï¼ˆé€šå¸¸ã¯ã‚¿ã‚¤ãƒˆãƒ«ï¼‰'
    required: true
  video2-path:
    description: '2ç•ªç›®ã®å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ï¼ˆé€šå¸¸ã¯æœ¬ç·¨ï¼‰'
    required: true
  video1-duration:
    description: 'æœ€åˆã®å‹•ç”»ã®é•·ã•ï¼ˆç§’ï¼‰- éŸ³å£°é…å»¶ã®è¨ˆç®—ç”¨'
    required: true
  output-path:
    description: 'å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹'
    required: true

outputs:
  video-generated:
    description: 'çµåˆå‹•ç”»ç”Ÿæˆã®æˆåŠŸå¯å¦'
    value: ${{ steps.concat.outputs.success }}

runs:
  using: "composite"
  steps:
    - name: Get video resolution
      id: get-resolution
      shell: bash
      run: |
        # 2ç•ªç›®ã®å‹•ç”»ï¼ˆæœ¬ç·¨ï¼‰ã®è§£åƒåº¦ã‚’å–å¾—
        RESOLUTION=$(ffprobe -v error -select_streams v:0 -show_entries stream=width,height -of csv=s=x:p=0 "${{ inputs.video2-path }}")
        echo "resolution=$RESOLUTION" >> $GITHUB_OUTPUT
        WIDTH=$(echo $RESOLUTION | cut -d'x' -f1)
        HEIGHT=$(echo $RESOLUTION | cut -d'x' -f2)
        echo "width=$WIDTH" >> $GITHUB_OUTPUT
        echo "height=$HEIGHT" >> $GITHUB_OUTPUT
        
    - name: Concatenate videos
      id: concat
      shell: bash
      run: |
        # éŸ³å£°é…å»¶ã‚’ãƒŸãƒªç§’ã«å¤‰æ›
        DELAY_MS=$(echo "${{ inputs.video1-duration }} * 1000" | bc | cut -d. -f1)
        
        echo "ðŸŽ¬ Concatenating videos"
        echo "Resolution: ${{ steps.get-resolution.outputs.resolution }}"
        echo "Audio delay: ${DELAY_MS}ms"
        
        # FFmpegã§å‹•ç”»ã‚’çµåˆ
        # - 1ç•ªç›®ã®å‹•ç”»ï¼ˆã‚¿ã‚¤ãƒˆãƒ«ï¼‰ã¯é€šå¸¸ç„¡éŸ³
        # - 2ç•ªç›®ã®å‹•ç”»ï¼ˆæœ¬ç·¨ï¼‰ã®éŸ³å£°ã‚’é©åˆ‡ã«é…å»¶ã•ã›ã‚‹
        ffmpeg -i "${{ inputs.video1-path }}" -i "${{ inputs.video2-path }}" \
          -filter_complex "[1:v]scale=${{ steps.get-resolution.outputs.width }}:${{ steps.get-resolution.outputs.height }}[v1];[0:v][v1]concat=n=2:v=1:a=0[outv];[1:a]adelay=${DELAY_MS}|${DELAY_MS}[outa]" \
          -map "[outv]" -map "[outa]" \
          -c:v libx264 -c:a aac -pix_fmt yuv420p \
          "${{ inputs.output-path }}"
        
        if [ -f "${{ inputs.output-path }}" ]; then
          echo "âœ… Videos concatenated successfully"
          echo "success=true" >> $GITHUB_OUTPUT
        else
          echo "âŒ Video concatenation failed"
          echo "success=false" >> $GITHUB_OUTPUT
          exit 1
        fi