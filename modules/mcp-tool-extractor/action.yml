name: 'MCP Tool Extractor'
description: 'Extract specific MCP tools from a full MCP configuration file'
author: 'KamuiCode'

inputs:
  input-file:
    description: 'å…¥åŠ›MCPãƒ•ã‚¡ã‚¤ãƒ«åï¼ˆä¾‹: 2.mcp.jsonï¼‰'
    required: true
  output-file:
    description: 'å‡ºåŠ›MCPãƒ•ã‚¡ã‚¤ãƒ«åï¼ˆä¾‹: extracted.mcp.jsonï¼‰'
    required: true
  tool-names:
    description: 'æŠ½å‡ºã™ã‚‹MCPãƒ„ãƒ¼ãƒ«åï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§è¤‡æ•°å¯ã€‚ä¾‹: t2i-kamui-imagen4-fast,t2m-kamui-lyriaï¼‰'
    required: true
  replace-env-vars:
    description: 'ç’°å¢ƒå¤‰æ•°ã‚’ç½®æ›ã™ã‚‹ã‹ã©ã†ã‹ï¼ˆtrue/falseï¼‰'
    required: false
    default: 'true'
  T2I_FAL_WAN_V22_A14B_URL:
    description: 'Secret for t2i-kamui-wan-v2-2-a14b'
    required: false
  T2V_FAL_WAN_V22_5B_FAST_URL:
    description: 'Secret for t2v-kamui-wan-v2-2-5b-fast'
    required: false
  T2I_FAL_QWEN_IMAGE_URL:
    description: 'Secret for t2i-kamui-qwen-image'
    required: false
  T2I_KAMUI_IMAGEN4_FAST_URL:
    description: 'Secret for t2i-kamui-imagen4-fast'
    required: false
  T2M_GOOGLE_LYRIA_URL:
    description: 'Secret for t2m-kamui-lyria'
    required: false

outputs:
  extraction-success:
    description: 'MCP tool extraction success status'
    value: ${{ steps.extract.outputs.success }}
  extracted-tools:
    description: 'List of extracted tools'
    value: ${{ steps.extract.outputs.tools }}

runs:
  using: "composite"
  steps:
    - name: Extract MCP tools
      id: extract
      shell: bash
      run: |
        echo "ğŸ“ Extracting tools: ${{ inputs.tool-names }}"
        echo "ğŸ“‚ Input file: ${{ inputs.input-file }}"
        echo "ğŸ“‚ Output file: ${{ inputs.output-file }}"
        
        INPUT_FILE="${{ inputs.input-file }}"
        OUTPUT_FILE="${{ inputs.output-file }}"
        
        if [ -f "$INPUT_FILE" ]; then
          # ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã®ãƒ„ãƒ¼ãƒ«åã‚’é…åˆ—ã«å¤‰æ›
          IFS=',' read -ra TOOLS <<< "${{ inputs.tool-names }}"
          
          # jqãƒ•ã‚£ãƒ«ã‚¿ã‚’æ§‹ç¯‰ã—ã¦è¤‡æ•°ã®ãƒ„ãƒ¼ãƒ«ã‚’æŠ½å‡º
          JQ_FILTER='{mcpServers: {'
          FIRST=true
          for tool in "${TOOLS[@]}"; do
            # ãƒ„ãƒ¼ãƒ«åã®å‰å¾Œã®ç©ºç™½ã‚’å‰Šé™¤
            tool=$(echo "$tool" | xargs)
            if [ "$FIRST" = true ]; then
              JQ_FILTER="$JQ_FILTER\"$tool\": .mcpServers[\"$tool\"]"
              FIRST=false
            else
              JQ_FILTER="$JQ_FILTER, \"$tool\": .mcpServers[\"$tool\"]"
            fi
          done
          JQ_FILTER="$JQ_FILTER}}"
          
          echo "ğŸ“ Using JQ filter: $JQ_FILTER"
          
          # jqã‚’ä½¿ã£ã¦æŒ‡å®šã•ã‚ŒãŸãƒ„ãƒ¼ãƒ«ã‚’æŠ½å‡º
          jq "$JQ_FILTER" "$INPUT_FILE" > "$OUTPUT_FILE"
          
          echo "ğŸ“‹ Extracted MCP configuration:"
          cat "$OUTPUT_FILE"
          
          # ç’°å¢ƒå¤‰æ•°ç½®æ›ãŒæœ‰åŠ¹ãªå ´åˆ
          if [ "${{ inputs.replace-env-vars }}" = "true" ]; then
            echo "ğŸ”„ Replacing environment variables..."
            
            # å„ãƒ„ãƒ¼ãƒ«ã«å¯¾å¿œã™ã‚‹ç’°å¢ƒå¤‰æ•°ã‚’ç½®æ›
            for tool in "${TOOLS[@]}"; do
              tool=$(echo "$tool" | xargs)
              ENV_VAR_NAME=""
              ENV_VAR_VALUE=""
              
              # ãƒ„ãƒ¼ãƒ«åã‹ã‚‰ç’°å¢ƒå¤‰æ•°åã‚’ãƒãƒƒãƒ”ãƒ³ã‚°
              case "$tool" in
                "t2i-kamui-wan-v2-2-a14b")
                  ENV_VAR_NAME="T2I_FAL_WAN_V22_A14B_URL"
                  ENV_VAR_VALUE="${{ inputs.T2I_FAL_WAN_V22_A14B_URL }}"
                  ;;
                "t2v-kamui-wan-v2-2-5b-fast")
                  ENV_VAR_NAME="T2V_FAL_WAN_V22_5B_FAST_URL"
                  ENV_VAR_VALUE="${{ inputs.T2V_FAL_WAN_V22_5B_FAST_URL }}"
                  ;;
                "t2i-kamui-qwen-image")
                  ENV_VAR_NAME="T2I_FAL_QWEN_IMAGE_URL"
                  ENV_VAR_VALUE="${{ inputs.T2I_FAL_QWEN_IMAGE_URL }}"
                  ;;
                "t2i-kamui-imagen4-fast")
                  ENV_VAR_NAME="T2I_KAMUI_IMAGEN4_FAST_URL"
                  ENV_VAR_VALUE="${{ inputs.T2I_KAMUI_IMAGEN4_FAST_URL }}"
                  ;;
                "t2m-kamui-lyria")
                  ENV_VAR_NAME="T2M_GOOGLE_LYRIA_URL"
                  ENV_VAR_VALUE="${{ inputs.T2M_GOOGLE_LYRIA_URL }}"
                  ;;
              esac
              
              if [ -n "$ENV_VAR_NAME" ] && [ -n "$ENV_VAR_VALUE" ]; then
                echo "âœ… Replacing $ENV_VAR_NAME for tool $tool"
                # sedã§ç’°å¢ƒå¤‰æ•°ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’ç½®æ›
                sed -i "s|\${$ENV_VAR_NAME}|$ENV_VAR_VALUE|g" "$OUTPUT_FILE"
              elif [ -n "$ENV_VAR_NAME" ]; then
                echo "âš ï¸ Warning: Secret $ENV_VAR_NAME not provided for tool $tool"
              fi
            done
          fi
          
          echo "ğŸ“‹ Final MCP configuration:"
          cat "$OUTPUT_FILE"
          
          # JSONã®æ¤œè¨¼
          if jq empty "$OUTPUT_FILE" 2>/dev/null; then
            echo "âœ… JSON syntax is valid"
            echo "success=true" >> $GITHUB_OUTPUT
            echo "tools=${{ inputs.tool-names }}" >> $GITHUB_OUTPUT
          else
            echo "âŒ JSON syntax error"
            echo "success=false" >> $GITHUB_OUTPUT
            exit 1
          fi
        else
          echo "âŒ Input file $INPUT_FILE not found"
          echo "success=false" >> $GITHUB_OUTPUT
          exit 1
        fi