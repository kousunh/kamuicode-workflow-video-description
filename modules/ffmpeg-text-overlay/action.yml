name: 'FFmpeg Text Overlay'
description: 'Apply text overlays to video using FFmpeg'
author: 'KamuiCode'

inputs:
  video-path:
    description: 'å…¥åŠ›å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹'
    required: true
  descriptions-json:
    description: 'èª¬æ˜Žæ–‡JSONãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹'
    required: true
  fontfile:
    description: 'ãƒ•ã‚©ãƒ³ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹'
    required: false
    default: '/usr/share/fonts/opentype/noto/NotoSansCJK-Regular.ttc'
  output-path:
    description: 'å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹'
    required: true

outputs:
  video-generated:
    description: 'ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤å‹•ç”»ç”Ÿæˆã®æˆåŠŸå¯å¦'
    value: ${{ steps.overlay.outputs.success }}

runs:
  using: "composite"
  steps:
    - name: Apply text overlays
      id: overlay
      shell: bash
      run: |
        # èª¬æ˜Žãƒ†ã‚­ã‚¹ãƒˆã®èª­ã¿è¾¼ã¿
        DESCRIPTIONS=$(cat "${{ inputs.descriptions-json }}")
        DESC_COUNT=$(echo "$DESCRIPTIONS" | jq '. | length')
        
        echo "ðŸ“ Applying $DESC_COUNT text overlays"
        
        # ãƒ•ã‚£ãƒ«ã‚¿ã‚³ãƒ³ãƒ—ãƒ¬ãƒƒã‚¯ã‚¹ã®æ§‹ç¯‰
        FILTER_COMPLEX=""
        
        for i in $(seq 0 $((DESC_COUNT - 1))); do
          DESC=$(echo "$DESCRIPTIONS" | jq -r ".[$i]")
          START_TIME_STR=$(echo "$DESC" | jq -r '.start_time // .timestamp // "00:00"')
          END_TIME_STR=$(echo "$DESC" | jq -r '.end_time // ""')
          TEXT=$(echo "$DESC" | jq -r '.text')
          ESCAPED_TEXT=$(echo "$TEXT" | sed "s/'/'\\\\''/g")
          FONTSIZE=$(echo "$DESC" | jq -r '.fontsize // 48')
          POSITION=$(echo "$DESC" | jq -r '.position // "top-left"')
          
          # Position-based coordinates
          case "$POSITION" in
            "top-left")
              X_POS="50"
              Y_POS="40"
              ;;
            "top-center")
              X_POS="(w-text_w)/2"
              Y_POS="40"
              ;;
            "top-right")
              X_POS="w-text_w-50"
              Y_POS="40"
              ;;
            "bottom-left")
              X_POS="50"
              Y_POS="h-th-50"
              ;;
            "bottom-center")
              X_POS="(w-text_w)/2"
              Y_POS="h-th-50"
              ;;
            "bottom-right")
              X_POS="w-text_w-50"
              Y_POS="h-th-50"
              ;;
            *)
              X_POS="(w-text_w)/2"
              Y_POS="40"
              ;;
          esac
          
          # MM:SS ã‚’ç§’ã«å¤‰æ›ï¼ˆã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’è¿½åŠ ï¼‰
          if [[ "$START_TIME_STR" =~ ^[0-9]+:[0-9]+$ ]]; then
            MINUTES=$(echo $START_TIME_STR | cut -d: -f1 | sed 's/^0*//')
            SECONDS=$(echo $START_TIME_STR | cut -d: -f2 | sed 's/^0*//')
            MINUTES=${MINUTES:-0}
            SECONDS=${SECONDS:-0}
            START_TIME=$((MINUTES * 60 + SECONDS))
          else
            echo "âš ï¸ Invalid start_time format: $START_TIME_STR"
            START_TIME=0
          fi
          
          # end_time ãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ãã‚Œã‚’ä½¿ç”¨ã€ãªã‘ã‚Œã° duration ã‚’ä½¿ç”¨
          if [ -n "$END_TIME_STR" ] && [ "$END_TIME_STR" != "null" ] && [[ "$END_TIME_STR" =~ ^[0-9]+:[0-9]+$ ]]; then
            END_MINUTES=$(echo $END_TIME_STR | cut -d: -f1 | sed 's/^0*//')
            END_SECONDS=$(echo $END_TIME_STR | cut -d: -f2 | sed 's/^0*//')
            END_MINUTES=${END_MINUTES:-0}
            END_SECONDS=${END_SECONDS:-0}
            END_TIME=$((END_MINUTES * 60 + END_SECONDS))
          else
            # æ—§å½¢å¼ã® duration ã‚’ã‚µãƒãƒ¼ãƒˆ
            DURATION=$(echo "$DESC" | jq -r '.duration // 6')
            END_TIME=$((START_TIME + DURATION))
          fi
          
          # ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’å‡ºåŠ›
          echo "  Text $((i+1)): '$TEXT' from $START_TIME_STR ($START_TIME s) to $END_TIME_STR ($END_TIME s)"
          
          # ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³/ã‚¢ã‚¦ãƒˆã®æ™‚é–“
          FADE_DURATION=0.5
          FADE_OUT_START=$(echo "$END_TIME - $FADE_DURATION" | bc)
          
          # ãƒ•ã‚£ãƒ«ã‚¿ã®è¿½åŠ ï¼ˆenableã§åŽ³å¯†ã«æ™‚é–“ã‚’åˆ¶å¾¡ï¼‰
          DRAWTEXT="drawtext=text='$ESCAPED_TEXT':fontfile='${{ inputs.fontfile }}':fontsize=$FONTSIZE:fontcolor=white:box=1:boxcolor=black@0.7:boxborderw=10:x=$X_POS:y=$Y_POS:enable='gte(t,$START_TIME)*lte(t,$END_TIME)':alpha='if(lt(t,$START_TIME+$FADE_DURATION),(t-$START_TIME)/$FADE_DURATION,if(gt(t,$FADE_OUT_START),($END_TIME-t)/$FADE_DURATION,1))'"
          
          if [ $i -eq 0 ]; then
            FILTER_COMPLEX="$DRAWTEXT"
          else
            FILTER_COMPLEX="$FILTER_COMPLEX,$DRAWTEXT"
          fi
        done
        
        # æ—¢å­˜ã®å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ï¼ˆå¿µã®ãŸã‚ï¼‰
        rm -f "${{ inputs.output-path }}"
        
        # FFmpegã§å‹•ç”»ã«ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’é©ç”¨
        ffmpeg -i "${{ inputs.video-path }}" \
          -vf "$FILTER_COMPLEX" \
          -c:v libx264 -c:a copy -pix_fmt yuv420p \
          "${{ inputs.output-path }}"
        
        if [ -f "${{ inputs.output-path }}" ]; then
          echo "âœ… Text overlays applied successfully to: ${{ inputs.output-path }}"
          echo "success=true" >> $GITHUB_OUTPUT
        else
          echo "âŒ Text overlay application failed"
          echo "success=false" >> $GITHUB_OUTPUT
          exit 1
        fi