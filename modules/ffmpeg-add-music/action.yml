name: 'FFmpeg Add Background Music'
description: 'Add background music to video with volume control and looping'
author: 'KamuiCode'

inputs:
  video-path:
    description: 'å…¥åŠ›å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹'
    required: true
  music-path:
    description: 'éŸ³æ¥½ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ï¼ˆmp3ã¾ãŸã¯wavï¼‰'
    required: true
  volume:
    description: 'éŸ³æ¥½ã®éŸ³é‡ï¼ˆ0.0-1.0ï¼‰'
    required: false
    default: '0.3'
  output-path:
    description: 'å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹'
    required: true

outputs:
  video-generated:
    description: 'éŸ³æ¥½ä»˜ãå‹•ç”»ç”Ÿæˆã®æˆåŠŸå¯å¦'
    value: ${{ steps.add-music.outputs.success }}

runs:
  using: "composite"
  steps:
    - name: Get video duration
      id: get-duration
      shell: bash
      run: |
        # å‹•ç”»ã®é•·ã•ã‚’å–å¾—
        VIDEO_DURATION=$(ffprobe -v error -show_entries format=duration -of default=noprint_wrappers=1:nokey=1 "${{ inputs.video-path }}")
        echo "duration=$VIDEO_DURATION" >> $GITHUB_OUTPUT
        echo "Video duration: $VIDEO_DURATION seconds"
        
    - name: Add background music
      id: add-music
      shell: bash
      run: |
        echo "ðŸŽµ Adding background music"
        echo "Music volume: ${{ inputs.volume }}"
        
        # éŸ³æ¥½ã‚’ãƒ«ãƒ¼ãƒ—ã—ã¦å‹•ç”»ã®é•·ã•ã«åˆã‚ã›ã‚‹
        ffmpeg -stream_loop -1 -i "${{ inputs.music-path }}" -i "${{ inputs.video-path }}" \
          -t ${{ steps.get-duration.outputs.duration }} \
          -filter_complex "[0:a]volume=${{ inputs.volume }}[music];[1:a][music]amix=inputs=2:duration=first:dropout_transition=2[aout]" \
          -map 1:v -map "[aout]" \
          -c:v copy -c:a aac -shortest \
          "${{ inputs.output-path }}"
        
        if [ -f "${{ inputs.output-path }}" ]; then
          echo "âœ… Background music added successfully"
          echo "success=true" >> $GITHUB_OUTPUT
        else
          echo "âŒ Failed to add background music"
          echo "success=false" >> $GITHUB_OUTPUT
          exit 1
        fi